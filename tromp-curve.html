<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tromp Curve Calculator</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Additional custom styles for Tromp Curve calculator */
        .kpi-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary-color);
        }
        
        .kpi-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .good { color: var(--success-color); }
        .fair { color: var(--warning-color); }
        .poor { color: var(--danger-color); }
        
        .chart-container {
            height: 400px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .recommendations {
            background: #fff9e6;
            border-left: 5px solid var(--warning-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .ai-analysis {
            background: #f0f8ff;
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .results-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        /* Splash Screen Styles */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-out;
        }
        
        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .splash-screen h1 {
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 600;
            text-align: center;
        }
        
        .splash-screen p {
            font-size: 18px;
            font-style: italic;
            text-align: center;
        }
        
        .splash-screen .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 30px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Print Header and Footer */
        .print-header {
            display: none;
        }
        
        .print-footer {
            display: none;
        }
        
        @media print {
            @page {
                size: A4;
                margin: 0.75in;
            }
            
            .print-header, .print-footer {
                display: block;
                position: fixed;
                left: 0;
                right: 0;
                background: white;
                z-index: 100;
                padding: 10px 0.75in;
            }
            
            .print-header {
                top: 0;
                height: 70px;
                border-bottom: 2px solid var(--primary-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 10pt;
            }
            
            .print-footer {
                bottom: 0;
                height: 30px;
                border-top: 1px solid var(--border-color);
                text-align: center;
                font-size: 9pt;
                color: var(--text-secondary);
                line-height: 30px;
            }
            
            body {
                padding-top: 80px;
                padding-bottom: 40px;
                font-size: 12pt;
            }
            
            .no-print {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid var(--border-color);
                page-break-inside: avoid;
            }
            
            .chart-container {
                page-break-inside: avoid;
            }
        }
        
        /* Custom styles for this calculator */
        .developer-info {
            background: var(--gradient-primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .developer-info h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .developer-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .api-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .api-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen">
        <div>
            <h1 data-en="Tromp Curve Calculator" data-ar="حاسبة منحنى ترومب">Tromp Curve Calculator</h1>
            <p data-en="Developed by: Mr. Fadi M. Darwesh" data-ar="تطوير: السيد فادي م. درويش">Developed by: Mr. Fadi M. Darwesh</p>
            <p data-en="QC & R&D Specialist" data-ar="أخصائي ضمان الجودة والبحوث والتطوير">QC & R&D Specialist</p>
            <p data-en="asrar.cement@gmail.com" data-ar="asrar.cement@gmail.com">asrar.cement@gmail.com</p>
            <div class="loader"></div>
        </div>
    </div>

    <!-- Print Header -->
    <div class="print-header">
        <div>
            <strong data-en="Tromp Curve Calculator" data-ar="حاسبة منحنى ترومب للمصنفات">Tromp Curve Calculator</strong>
        </div>
        <div>
            <strong data-en="Confidential Report" data-ar="تقرير سري">Confidential Report</strong>
        </div>
    </div>

    <!-- Print Footer -->
    <div class="print-footer">
        <span data-en="Mr. Fadi M. Darwesh - QC & R&D Specialist - asrar.cement@gmail.com" data-ar="السيد فادي م. درويش - أخصائي ضمان الجودة والبحوث والتطوير - asrar.cement@gmail.com">Mr. Fadi M. Darwesh - QC & R&D Specialist - asrar.cement@gmail.com</span>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header no-print">
            <div class="header-content">
                <div class="logo">
                    <h1 data-en="Tromp Curve Calculator" data-ar="حاسبة منحنى ترومب للمصنفات">Tromp Curve Calculator</h1>
                </div>
                <div class="header-controls">
                    <div class="language-switch">
                        <button class="lang-btn active" id="lang-en">English</button>
                        <button class="lang-btn" id="lang-ar">العربية</button>
                    </div>
                </div>
            </div>
        <a href="index.html" class="back-btn" style="position: fixed; top: 20px; right: 20px; background: var(--secondary); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; z-index: 100;"><i class="fas fa-arrow-right"></i>العودة للرئيسية</a>
</header>

        <div class="main-content">
            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-content">
                    <h2 data-en="Tromp Curve Analysis for Separator Performance" data-ar="تحليل منحنى ترومب لأداء المصنفات">Tromp Curve Analysis for Separator Performance</h2>
                    <p data-en="Advanced tool for calculating and analyzing Tromp curves to evaluate separator efficiency, cut size, and separation sharpness using industry-standard parameters" data-ar="أداة متقدمة لحساب وتحليل منحنيات ترومب لتقييم كفاءة المصنف وحجم القطع وحدة الفصل باستخدام معايير الصناعة القياسية">Advanced tool for calculating and analyzing Tromp curves to evaluate separator efficiency, cut size, and separation sharpness using industry-standard parameters</p>
                </div>
            </section>

            <!-- Company & Report Information -->
            <div class="card">
                <h2 class="section-title" data-en="Company & Report Information" data-ar="معلومات الشركة والتقرير">Company & Report Information</h2>
                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="company-name" data-en="Company Name" data-ar="اسم الشركة">Company Name</label>
                        <input type="text" id="company-name" placeholder="Enter company name">
                    </div>
                    <div class="input-group">
                        <label for="report-date" data-en="Report Date" data-ar="تاريخ التقرير">Report Date</label>
                        <input type="date" id="report-date">
                    </div>
                    <div class="input-group">
                        <label for="report-preparer" data-en="Report Prepared By" data-ar="معد التقرير">Report Prepared By</label>
                        <input type="text" id="report-preparer" placeholder="Enter preparer name">
                    </div>
                    <div class="input-group">
                        <label for="report-position" data-en="Preparer Position" data-ar="منصب معد التقرير">Preparer Position</label>
                        <input type="text" id="report-position" placeholder="Enter preparer position">
                    </div>
                    <div class="input-group">
                        <label for="product-type" data-en="Product Type" data-ar="نوع المنتج">Product Type</label>
                        <input type="text" id="product-type" placeholder="e.g., OPC, PPC, etc.">
                    </div>
                    <div class="input-group">
                        <label for="production-date" data-en="Production Date" data-ar="تاريخ الإنتاج">Production Date</label>
                        <input type="date" id="production-date">
                    </div>
                </div>
            </div>

            <!-- Tromp Curve Parameters -->
            <div class="card">
                <h2 class="section-title" data-en="Tromp Curve Parameters" data-ar="معايير منحنى ترومب">Tromp Curve Parameters</h2>
                <div class="grid-3" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="separator-type" data-en="Separator Type" data-ar="نوع المصنف">Separator Type</label>
                        <select id="separator-type">
                            <option value="" data-en="Select Separator Type" data-ar="اختر نوع المصنف">Select Separator Type</option>
                            <option value="1st-gen" data-en="1st Generation (Sturtevant, Raymond)" data-ar="الجيل الأول (ستورتفانت، ريموند)">1st Generation (Sturtevant, Raymond)</option>
                            <option value="2nd-gen" data-en="2nd Generation (Cyclone Air Separator)" data-ar="الجيل الثاني (سايكلون)">2nd Generation (Cyclone Air Separator)</option>
                            <option value="3rd-gen" data-en="3rd Generation (HES - O-Sepa, Sepax, Sepmaster)" data-ar="الجيل الثالث (عالية الكفاءة)">3rd Generation (HES - O-Sepa, Sepax, Sepmaster)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="separator-model" data-en="Separator Model" data-ar="موديل المصنف">Separator Model</label>
                        <input type="text" id="separator-model" placeholder="e.g., O-Sepa, Sepax, etc.">
                    </div>
                    <div class="input-group">
                        <label for="air-flow" data-en="Separator Air Flow (m³/h)" data-ar="تدفق الهواء في المصنف (م³/ساعة)">Separator Air Flow (m³/h)</label>
                        <input type="number" id="air-flow" placeholder="Enter air flow">
                    </div>
                    <div class="input-group">
                        <label for="particle-size-range" data-en="Particle Size Range (μm)" data-ar="نطاق حجم الجسيمات (ميكرومتر)">Particle Size Range (μm)</label>
                        <input type="text" id="particle-size-range" placeholder="e.g., 1-200">
                    </div>
                    <div class="input-group">
                        <label for="feed-rate" data-en="Feed Rate (t/h)" data-ar="معدل التغذية (طن/ساعة)">Feed Rate (t/h)</label>
                        <input type="number" id="feed-rate" placeholder="Enter feed rate">
                    </div>
                    <div class="input-group">
                        <label for="fines-rate" data-ar="معدل الناعم (طن/ساعة)" data-en="Fines Rate (t/h)">Fines Rate (t/h)</label>
                        <input type="number" id="fines-rate" placeholder="Enter fines rate">
                    </div>
                    <div class="input-group">
                        <label for="rejects-rate" data-en="Rejects Rate (t/h)" data-ar="معدل المرفوض (طن/ساعة)">Rejects Rate (t/h)</label>
                        <input type="number" id="rejects-rate" placeholder="Enter rejects rate">
                    </div>
                    <div class="input-group">
                        <label for="separator-efficiency" data-en="Separator Efficiency (%)" data-ar="كفاءة المصنف (%)">Separator Efficiency (%)</label>
                        <input type="number" id="separator-efficiency" placeholder="Enter efficiency">
                    </div>
                    <div class="input-group">
                        <label for="cut-size" data-en="Cut Size (d50) (μm)" data-ar="حجم القطع (d50) (ميكرومتر)">Cut Size (d50) (μm)</label>
                        <input type="number" id="cut-size" placeholder="Enter cut size">
                    </div>
                </div>
            </div>

            <!-- Target Settings -->
            <div class="card">
                <h2 class="section-title" data-en="Target Settings" data-ar="إعدادات الأهداف">Target Settings</h2>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 15px;" data-en="Set your factory's specific targets for 'Good' and 'Fair' ratings." data-ar="حدد أهداف مصنعك الخاصة لتقييمات 'جيد' و 'مقبول'.">Set your factory's specific targets for 'Good' and 'Fair' ratings.</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-en="KPI" data-ar="المؤشر">KPI</th>
                            <th data-en="Rating Logic" data-ar="منطق التقييم">Rating Logic</th>
                            <th data-en="Target: Good" data-ar="الهدف: جيد">Target: Good</th>
                            <th data-en="Target: Fair" data-ar="الهدف: مقبول">Target: Fair</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td data-en="Separation Efficiency (%)" data-ar="كفاءة الفصل (%)">Separation Efficiency (%)</td>
                            <td><span data-en="Higher is Better" data-ar="الأعلى أفضل">Higher is Better</span></td>
                            <td><input type="number" id="target-sep-eff-good" value="85" step="1"></td>
                            <td><input type="number" id="target-sep-eff-fair" value="75" step="1"></td>
                        </tr>
                        <tr>
                            <td data-en="Cut Size (μm)" data-ar="حجم القطع (ميكرومتر)">Cut Size (μm)</td>
                            <td><span data-en="Lower is Better" data-ar="الأقل أفضل">Lower is Better</span></td>
                            <td><input type="number" id="target-d50-good" value="30" step="1"></td>
                            <td><input type="number" id="target-d50-fair" value="35" step="1"></td>
                        </tr>
                        <tr>
                            <td data-en="Bypass Factor (%)" data-ar="عامل التجاوز (%)">Bypass Factor (%)</td>
                            <td><span data-en="Lower is Better" data-ar="الأقل أفضل">Lower is Better</span></td>
                            <td><input type="number" id="target-bypass-good" value="10" step="1"></td>
                            <td><input type="number" id="target-bypass-fair" value="15" step="1"></td>
                        </tr>
                        <tr>
                            <td data-en="Misplacement Index" data-ar="مؤشر الخسارة">Misplacement Index</td>
                            <td><span data-en="Lower is Better" data-ar="الأقل أفضل">Lower is Better</span></td>
                            <td><input type="number" id="target-misplacement-good" value="0.35" step="0.01"></td>
                            <td><input type="number" id="target-misplacement-fair" value="0.5" step="0.01"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Data Input Tables -->
            <div class="card">
                <h2 class="section-title" data-en="Particle Size Analysis" data-ar="تحليل حجم الجسيمات">Particle Size Analysis</h2>
                
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="mass-balance-sieve" data-en="Sieve for Mass Balance Calculation" data-ar="منخل حساب موازنة الكتلة">Sieve for Mass Balance Calculation</label>
                    <select id="mass-balance-sieve" style="max-width: 300px;"></select>
                    <small style="color: var(--text-secondary); display: block; margin-top: 5px;" data-en="Select the reference sieve for calculating circulating load. This sieve must have Feed, Fines, and Rejects data." data-ar="اختر المنخل المرجعي لحساب الحمل المتداول. يجب أن يحتوي هذا المنخل على بيانات للتغذية، الناعم، والمرفوض.">Select the reference sieve for calculating circulating load. This sieve must have Feed, Fines, and Rejects data.</small>
                </div>
                
                <p style="text-align: center; margin: 15px 0; color: var(--text-secondary);" data-en="Enter cumulative percentage passing for each sieve size:" data-ar="أدخل النسبة المئوية التراكمية المارة لكل منخل:">Enter cumulative percentage passing for each sieve size:</p>
                
                <table class="data-table" id="psd-table">
                    <thead>
                        <tr>
                            <th data-en="Sieve Size (μm)" data-ar="حجم المنخل (ميكرومتر)">Sieve Size (μm)</th>
                            <th data-en="Feed (% Passing)" data-ar="التغذية (% مار)">Feed (% Passing)</th>
                            <th data-en="Fines (% Passing)" data-ar="الناعم (% مار)">Fines (% Passing)</th>
                            <th data-en="Rejects (% Passing)" data-ar="المرفوض (% مار)">Rejects (% Passing)</th>
                            <th data-en="Actions" data-ar="الإجراءات">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="psd-table-body">
                    </tbody>
                </table>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="add-sieve-row" data-en="Add Sieve Size" data-ar="إضافة حجم منخل">Add Sieve Size</button>
                    <button class="btn btn-secondary" id="add-default-sieves" data-en="Add Common Sieves" data-ar="إضافة المناخل الشائعة">Add Common Sieves</button>
                    <button class="btn btn-warning" id="load-example" data-en="Load Example Data" data-ar="تحميل بيانات مثال">Load Example Data</button>
                    <button class="btn btn-success" id="save-data" data-en="Save Data" data-ar="حفظ البيانات">Save Data</button>
                    <button class="btn btn-secondary" id="load-data" data-en="Load Data" data-ar="تحميل البيانات">Load Data</button>
                    <button class="btn btn-lg btn-primary" id="calculate-btn" data-en="Calculate Tromp Curve" data-ar="حساب منحنى ترومب">Calculate Tromp Curve</button>
                </div>
            </div>

            <!-- Separation Data -->
            <div class="card">
                <h2 class="section-title" data-en="Separation Data" data-ar="بيانات الفصل">Separation Data</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-en="Particle Size (μm)" data-ar="حجم الجسيم (ميكرومتر)">Particle Size (μm)</th>
                            <th data-en="Feed Distribution (%)" data-ar="توزيع التغذية (%)">Feed Distribution (%)</th>
                            <th data-en="Separation Probability (%)" data-ar="احتمالية الفصل (%)">Separation Probability (%)</th>
                            <th data-en="Rejection Rate (%)" data-ar="معدل الرفض (%)">Rejection Rate (%)</th>
                        </tr>
                    </thead>
                    <tbody id="separation-data-body">
                    </tbody>
                </table>
            </div>

            <!-- Efficiency Calculations -->
            <div class="card">
                <h2 class="section-title" data-en="Efficiency Calculations" data-ar="حسابات الكفاءة">Efficiency Calculations</h2>
                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="calc-separator-efficiency" data-en="Calculated Separator Efficiency (%)" data-ar="كفاءة المصنف المحسوبة (%)">Calculated Separator Efficiency (%)</label>
                        <input type="number" id="calc-separator-efficiency" readonly>
                    </div>
                    <div class="input-group">
                        <label for="calc-cut-size" data-en="Calculated Cut Size (μm)" data-ar="حجم القطع المحسوب (ميكرومتر)">Calculated Cut Size (μm)</label>
                        <input type="number" id="calc-cut-size" readonly>
                    </div>
                    <div class="input-group">
                        <label for="calc-bypass-factor" data-en="Bypass Factor (%)" data-ar="عامل التجاوز (%)">Bypass Factor (%)</label>
                        <input type="number" id="calc-bypass-factor" readonly>
                    </div>
                    <div class="input-group">
                        <label for="calc-misplacement-index" data-en="Misplacement Index" data-ar="مؤشر الخسارة">Misplacement Index</label>
                        <input type="number" id="calc-misplacement-index" readonly>
                    </div>
                </div>
            </div>

            <!-- Advanced AI Analysis -->
            <div class="card">
                <h2 class="section-title" data-en="Advanced AI Analysis" data-ar="التحليل المتقدم بالذكاء الاصطناعي">Advanced AI Analysis</h2>
                
                <div id="api-status" class="api-status disconnected" data-en="API: Disconnected" data-ar="API: غير متصل">
                    API: Disconnected
                </div>
                
                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="api-key" data-en="🤖 OpenAI API Key (اختياري)" data-ar="🤖 مفتاح OpenAI API (اختياري)">🤖 OpenAI API Key (اختياري)</label>
                        <input type="password" id="api-key" placeholder="أدخل مفتاح OpenAI API الخاص بك - Enter your OpenAI API key">
                        <small style="color: var(--text-secondary); display: block; margin-top: 8px; font-size: 14px;" data-en="Get your free API key from https://platform.openai.com (Required for AI analysis)" data-ar="احصل على مفتاح مجاني من https://platform.openai.com (مطلوب لتحليل الذكاء الاصطناعي)">Get your free API key from https://platform.openai.com (Required for AI analysis)</small>
                    </div>
                    <div class="input-group">
                        <label for="api-model" data-en="AI Model" data-ar="نموذج الذكاء الاصطناعي">AI Model</label>
                        <select id="api-model">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast & Cost-effective)</option>
                            <option value="gpt-4">GPT-4 (Most Advanced)</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="test-api" data-en="Test API Connection" data-ar="اختبار اتصال API">Test API Connection</button>
                    <button class="btn btn-primary" id="ai-analysis-btn" data-en="Get AI Analysis" data-ar="الحصول على تحليل الذكاء الاصطناعي">Get AI Analysis</button>
                    <button class="btn btn-success" id="save-api-key" data-en="Save API Key" data-ar="حفظ المفتاح">Save API Key</button>
                </div>
            </div>

            <!-- Additional Notes -->
            <div class="card">
                <h2 class="section-title" data-en="Additional Notes" data-ar="ملاحظات إضافية">Additional Notes</h2>
                <div class="input-group">
                    <label for="additional-notes" data-en="Add your notes and observations here:" data-ar="أضف ملاحظاتك وتوصياتك هنا:">Add your notes and observations here:</label>
                    <textarea id="additional-notes" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; font-family: var(--font-arabic);" placeholder="Enter any additional notes, observations, or recommendations..."></textarea>
                </div>
                <small style="color: var(--text-secondary);" data-en="These notes will be included in the final report" data-ar="هذه الملاحظات ستظهر في التقرير النهائي">These notes will be included in the final report</small>
            </div>
            
            <!-- Results Section -->
            <div class="results-section" id="results-section">
                <div class="card">
                    <h2 class="section-title" data-en="Tromp Curve Results" data-ar="نتائج منحنى ترومب">Tromp Curve Results</h2>
                    
                    <div class="grid-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <!-- KPI Cards -->
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Separation Efficiency" data-ar="كفاءة الفصل">Separation Efficiency</div>
                            <div class="kpi-value" id="separation-eff-value">-</div>
                            <div class="kpi-label" id="separation-eff-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="The percentage of material correctly classified by the separator based on particle size." data-ar="النسبة المئوية للمادة المصنفة بشكل صحيح بواسطة المصنف حسب حجم الجسيم."></div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Cut Size (d50)" data-ar="حجم القطع (d50)">Cut Size (d50)</div>
                            <div class="kpi-value" id="cut-size-value">-</div>
                            <div class="kpi-label" id="cut-size-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="The particle size at which there is 50% probability of separation to the coarse product." data-ar="حجم الجسيم الذي توجد عنده احتمالية 50% للفصل إلى المنتج الخشن."></div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Bypass Factor" data-ar="عامل التجاوز">Bypass Factor</div>
                            <div class="kpi-value" id="bypass-factor-value">-</div>
                            <div class="kpi-label" id="bypass-factor-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="The minimum value of the Tromp curve representing misplacement of fine particles to coarse product." data-ar="أقل قيمة لمنحنى ترومب تمثل خسارة الجسيمات الناعمة إلى المنتج الخشن."></div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Misplacement Index" data-ar="مؤشر الخسارة">Misplacement Index</div>
                            <div class="kpi-value" id="misplacement-index-value">-</div>
                            <div class="kpi-label" id="misplacement-index-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="Measure of separation sharpness - the ratio of bypass to total efficiency loss." data-ar="مقياس حدة الفصل - نسبة التجاوز إلى إجمالي فقدان الكفاءة."></div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="chart-container">
                        <canvas id="tromp-curve-chart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="psd-chart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="kpi-chart"></canvas>
                    </div>
                    
                    <!-- Detailed Calculations -->
                    <div class="report-section">
                        <h3 class="section-heading" data-en="Detailed Calculations" data-ar="الحسابات التفصيلية">Detailed Calculations</h3>
                        <div id="detailed-calculations"></div>
                    </div>
                    
                    <!-- AI Analysis -->
                    <div class="ai-analysis" id="ai-analysis-container">
                        <h3 class="section-heading" data-en="AI Analysis" data-ar="تحليل الذكاء الاصطناعي">AI Analysis</h3>
                        <div id="ai-analysis-content">
                            <p data-en="No AI analysis available yet. Click 'Get AI Analysis' to generate." data-ar="لا يوجد تحليل بالذكاء الاصطناعي بعد. انقر على 'الحصول على تحليل الذكاء الاصطناعي' لإنشائه.">No AI analysis available yet. Click 'Get AI Analysis' to generate.</p>
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div class="recommendations">
                        <h3 class="section-heading" data-en="Recommendations" data-ar="التوصيات">Recommendations</h3>
                        <div id="recommendations-content"></div>
                    </div>
                    
                    <div class="button-group no-print">
                        <button class="btn btn-success" id="print-report" data-en="🖨️ Print Report" data-ar="🖨️ طباعة التقرير">🖨️ Print Report</button>
                        <button class="btn btn-warning" id="export-pdf" data-en="📄 Export as PDF" data-ar="📄 تصدير كـ PDF">📄 Export as PDF</button>
                        <button class="btn btn-secondary" id="new-analysis" data-en="🔄 New Analysis" data-ar="🔄 تحليل جديد">🔄 New Analysis</button>
                    </div>
                </div>
            </div>

            <!-- Developer Information -->
            <div class="developer-info no-print">
                <h3 data-en="System Developer" data-ar="مطور النظام">System Developer</h3>
                <p><strong data-en="Mr. Fadi M. Darwesh" data-ar="السيد فادي م. درويش">Mr. Fadi M. Darwesh</strong></p>
                <p data-en="QC & R&D Specialist" data-ar="أخصائي ضمان الجودة والبحوث والتطوير">QC & R&D Specialist</p>
                <p>asrar.cement@gmail.com</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer no-print">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 data-en="Tromp Curve Calculator" data-ar="حاسبة منحنى ترومب">Tromp Curve Calculator</h4>
                    <p data-en="Advanced calculation tools for separator performance evaluation using Tromp curve analysis" data-ar="أدوات حساب متقدمة لتقييم أداء المصنفات باستخدام تحليل منحنى ترومب">Advanced calculation tools for separator performance evaluation using Tromp curve analysis</p>
                </div>
                <div class="footer-section">
                    <h4 data-en="Developer" data-ar="المطور">Developer</h4>
                    <ul>
                        <li>Mr. Fadi M. Darwesh</li>
                        <li data-en="QC & R&D Specialist" data-ar="أخصائي ضمان الجودة والبحوث والتطوير">QC & R&D Specialist</li>
                        <li>asrar.cement@gmail.com</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4 data-en="Features" data-ar="المميزات">Features</h4>
                    <ul>
                        <li data-en="Tromp Curve Analysis" data-ar="تحليل منحنى ترومب">Tromp Curve Analysis</li>
                        <li data-en="KPI Calculations" data-ar="حسابات المؤشرات">KPI Calculations</li>
                        <li data-en="AI-Powered Insights" data-ar="رؤى مدعومة بالذكاء الاصطناعي">AI-Powered Insights</li>
                        <li data-en="Professional Reports" data-ar="تقارير احترافية">Professional Reports</li>
                    </ul>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--gray-700);">
                <p data-en="© 2025 Tromp Curve Calculator System. All rights reserved." data-ar="© 2025 نظام حاسبة منحنى ترومب. جميع الحقوق محفوظة.">© 2025 Tromp Curve Calculator System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <i class="fas fa-cog"></i>
            <p data-en="Calculating..." data-ar="جاري الحساب...">Calculating...</p>
        </div>
    </div>

    <script>
        // Language switching functionality
        document.getElementById('lang-en').addEventListener('click', function() {
            setLanguage('en');
        });
        
        document.getElementById('lang-ar').addEventListener('click', function() {
            setLanguage('ar');
        });
        
        function setLanguage(lang) {
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lang-${lang}`).classList.add('active');
            
            // Update text content based on data attributes
            document.querySelectorAll('[data-en]').forEach(element => {
                if (lang === 'en') {
                    element.textContent = element.getAttribute('data-en');
                } else {
                    element.textContent = element.getAttribute('data-ar');
                }
            });
            
            // Update placeholders
            document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(element => {
                const enText = element.getAttribute('data-en-placeholder');
                const arText = element.getAttribute('data-ar-placeholder');
                
                if (enText && arText) {
                    element.placeholder = lang === 'en' ? enText : arText;
                }
            });
            
            // Update direction
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
        }
        
        // Initialize with English
        setLanguage('en');
        
        // Initialize splash screen
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('splash-screen').classList.add('hidden');
            }, 2000);
            
            // Set current dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            document.getElementById('production-date').value = today;
            
            // Initialize with common sieves
            addSieveRow(1);
            addSieveRow(2);
            addSieveRow(4);
            addSieveRow(8);
            addSieveRow(16);
            addSieveRow(24);
            addSieveRow(32);
            addSieveRow(48);
            addSieveRow(64);
            addSieveRow(96);
            addSieveRow(200);
            
            // Load saved API key
            const savedApiKey = localStorage.getItem('tromp_curve_api_key');
            if (savedApiKey) {
                document.getElementById('api-key').value = savedApiKey;
                updateApiStatus('connected', 'API: Connected (Using saved key)');
            }
            
            updateMassBalanceSieveSelect();
        });

        function addSieveRow(defaultSize = '') {
            const tableBody = document.getElementById('psd-table-body');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <input type="number" step="0.1" min="0.1" class="sieve-size-input" value="${defaultSize}" placeholder="Enter size">
                </td>
                <td>
                    <input type="number" step="0.01" min="0" max="100" class="psd-input" data-stream="feed" placeholder="0-100">
                </td>
                <td>
                    <input type="number" step="0.01" min="0" max="100" class="psd-input" data-stream="fines" placeholder="0-100">
                </td>
                <td>
                    <input type="number" step="0.01" min="0" max="100" class="psd-input" data-stream="rejects" placeholder="0-100">
                </td>
                <td>
                    <button class="btn btn-danger remove-row" data-en="Remove" data-ar="إزالة">Remove</button>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            
            newRow.querySelector('.sieve-size-input').addEventListener('change', updateMassBalanceSieveSelect);
            
            newRow.querySelector('.remove-row').addEventListener('click', function() {
                if (tableBody.children.length > 1) {
                    tableBody.removeChild(newRow);
                    updateMassBalanceSieveSelect();
                } else {
                    alert('You must have at least one sieve size!');
                }
            });
        }

        function updateMassBalanceSieveSelect() {
            const select = document.getElementById('mass-balance-sieve');
            const currentVal = select.value;
            select.innerHTML = '';
            
            const inputs = document.querySelectorAll('.sieve-size-input');
            let sizeFound = false;

            inputs.forEach(input => {
                const size = parseFloat(input.value);
                if (!isNaN(size) && size > 0) {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = `${size} μm`;
                    select.appendChild(option);
                    if (size.toString() === currentVal) {
                        select.value = currentVal;
                        sizeFound = true;
                    }
                }
            });
            
            if (!sizeFound && select.options.length > 0) {
                const defaultSieves = ['48', '64', '96', '200'];
                let selected = false;
                for (const sieve of defaultSieves) {
                    if (Array.from(select.options).some(opt => opt.value === sieve)) {
                        select.value = sieve;
                        selected = true;
                        break;
                    }
                }
                if (!selected) {
                     select.selectedIndex = Math.floor(select.options.length / 2);
                }
            }
        }

        function sieveSizeExists(size) {
            const inputs = document.querySelectorAll('.sieve-size-input');
            for (let input of inputs) {
                if (parseFloat(input.value) === size) {
                    return true;
                }
            }
            return false;
        }

        function updateApiStatus(status, message) {
            const apiStatus = document.getElementById('api-status');
            apiStatus.className = `api-status ${status}`;
            apiStatus.textContent = message;
        }

        // Calculate Tromp Curve
        document.getElementById('calculate-btn').addEventListener('click', function() {
            calculateTrompCurve();
        });

        function calculateTrompCurve() {
            const psdData = collectPSDData();
            
            if (psdData.sieveSizes.length === 0) {
                alert('Please enter at least one sieve size with data!');
                return;
            }
            
            try {
                // Show loading
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                // Perform calculations with a small delay for better UX
                setTimeout(() => {
                    try {
                        const results = performTrompCalculations(psdData);
                        
                        if (!results) {
                            console.error('Calculation failed: No results returned');
                            alert('خطأ في الحساب! يرجى التحقق من البيانات المدخلة');
                            return;
                        }
                        
                        // Success
                        document.getElementById('loading-overlay').classList.add('hidden');
                        displayTrompResults(results);
                        updateSeparationData(results);
                        document.getElementById('results-section').style.display = 'block';
                        
                    } catch (calcError) {
                        console.error('Calculation error:', calcError);
                        document.getElementById('loading-overlay').classList.add('hidden');
                        alert('خطأ في الحساب: ' + calcError.message);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error in calculate button:', error);
                document.getElementById('loading-overlay').classList.add('hidden');
                alert('حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى.');
            }
        }

        // Collect PSD data
        function collectPSDData() {
            const psdData = {
                sieveSizes: [],
                feed: [],
                fines: [],
                rejects: []
            };
            
            const rows = document.querySelectorAll('#psd-table-body tr');
            rows.forEach(row => {
                const sizeInput = row.querySelector('.sieve-size-input');
                const feedInput = row.querySelector('.psd-input[data-stream="feed"]');
                const finesInput = row.querySelector('.psd-input[data-stream="fines"]');
                const rejectsInput = row.querySelector('.psd-input[data-stream="rejects"]');
                
                if (sizeInput && feedInput && finesInput && rejectsInput) {
                    const size = parseFloat(sizeInput.value);
                    const feedVal = parseFloat(feedInput.value);
                    const finesVal = parseFloat(finesInput.value);
                    const rejectsVal = parseFloat(rejectsInput.value);
                    
                    if (!isNaN(size) && size > 0 && 
                        (!isNaN(feedVal) || !isNaN(finesVal) || !isNaN(rejectsVal))) {
                        psdData.sieveSizes.push(size);
                        psdData.feed.push(isNaN(feedVal) ? 0 : feedVal);
                        psdData.fines.push(isNaN(finesVal) ? 0 : finesVal);
                        psdData.rejects.push(isNaN(rejectsVal) ? 0 : rejectsVal);
                    }
                }
            });
            
            // Sort by sieve size (ascending)
            const combined = psdData.sieveSizes.map((size, index) => ({
                size,
                feed: psdData.feed[index],
                fines: psdData.fines[index],
                rejects: psdData.rejects[index]
            }));
            
            combined.sort((a, b) => a.size - b.size);
            
            psdData.sieveSizes = combined.map(item => item.size);
            psdData.feed = combined.map(item => item.feed);
            psdData.fines = combined.map(item => item.fines);
            psdData.rejects = combined.map(item => item.rejects);
            
            return psdData;
        }
        
        // Convert cumulative passing to fractional passing
        function getFractionalPassing(cumulativeArray) {
            const fractional = [];
            let prevPassing = 0;
            for (let i = 0; i < cumulativeArray.length; i++) {
                const currentPassing = Math.max(prevPassing, cumulativeArray[i]);
                const fraction = currentPassing - prevPassing;
                fractional.push(fraction);
                prevPassing = currentPassing;
            }
            return fractional;
        }

        function interpolateSize(targetValue, value1, value2, size1, size2) {
            if (value2 - value1 === 0) {
                return size1;
            }
            const logSize1 = Math.log(size1);
            const logSize2 = Math.log(size2);
            const interpLog = logSize1 + (targetValue - value1) * (logSize2 - logSize1) / (value2 - value1);
            return Math.exp(interpLog);
        }

        function performTrompCalculations(psdData) {
            const clSieveSize = parseFloat(document.getElementById('mass-balance-sieve').value);
            if (isNaN(clSieveSize)) {
                alert('Please select a valid sieve for Mass Balance calculation!');
                return null;
            }
            
            const sieveIndex = psdData.sieveSizes.indexOf(clSieveSize);
            if (sieveIndex === -1) {
                alert(`Selected sieve ${clSieveSize} μm not found in data table.`);
                return null;
            }
            
            const pass_f = psdData.feed[sieveIndex];
            const pass_s = psdData.fines[sieveIndex];
            const pass_g = psdData.rejects[sieveIndex];
            
            const R_f = 100 - pass_f;
            const R_s = 100 - pass_s;
            const R_g = 100 - pass_g;
            
            if (Math.abs(R_g - R_f) < 0.01) {
                alert(`Calculation Error: Feed and Rejects have identical retained values (${R_f.toFixed(1)}%) at ${clSieveSize} μm. Cannot calculate Tromp Curve.`);
                return null;
            }
            
            const circulatingLoad = (R_f - R_s) / (R_g - R_f) * 100;
            
            if (circulatingLoad < 0) {
                 alert(`Warning: Calculated Circulating Load is negative (${circulatingLoad.toFixed(1)}%). This indicates a data entry error or sampling issue. Results will be inaccurate.`);
            }

            // Calculate Tromp Curve
            const trompValues = [];
            const CL_ratio = circulatingLoad / 100;
            const s_frac_mass = 1 / (1 + CL_ratio);

            const feed_frac_pass = getFractionalPassing(psdData.feed);
            const fines_frac_pass = getFractionalPassing(psdData.fines);

            for (let i = 0; i < psdData.sieveSizes.length; i++) {
                let prob_to_fines = 0;
                
                if (feed_frac_pass[i] > 0.001) {
                    prob_to_fines = s_frac_mass * (fines_frac_pass[i] / feed_frac_pass[i]);
                } else if (fines_frac_pass[i] > 0.001) {
                    prob_to_fines = 0;
                }
                
                let trompValue = (1 - prob_to_fines) * 100;
                trompValue = Math.max(0, Math.min(trompValue, 100));
                trompValues.push(trompValue);
            }

            // Calculate Tromp Curve KPIs
            let d25 = null, d50 = null, d75 = null;
            
            for (let i = 0; i < trompValues.length - 1; i++) {
                if (trompValues[i] <= 25 && trompValues[i+1] >= 25 && d25 === null) {
                    d25 = interpolateSize(25, trompValues[i], trompValues[i+1], psdData.sieveSizes[i], psdData.sieveSizes[i+1]);
                }
                if (trompValues[i] <= 50 && trompValues[i+1] >= 50 && d50 === null) {
                    d50 = interpolateSize(50, trompValues[i], trompValues[i+1], psdData.sieveSizes[i], psdData.sieveSizes[i+1]);
                }
                if (trompValues[i] <= 75 && trompValues[i+1] >= 75 && d75 === null) {
                    d75 = interpolateSize(75, trompValues[i], trompValues[i+1], psdData.sieveSizes[i], psdData.sieveSizes[i+1]);
                }
            }
            
            const imperfection = (d25 && d50 && d75 && d50 > 0) ? (d75 - d25) / (2 * d50) : null;
            const sharpness = (d25 && d75 && d75 > 0) ? d25 / d75 : null;
            const bypass = Math.min(...trompValues);
            const separationEfficiency = 100 - bypass;
            const misplacementIndex = bypass / (100 - bypass);
            
            return {
                circulatingLoad,
                clSieve: clSieveSize,
                separationEfficiency,
                cutSize: d50,
                imperfection,
                sharpness,
                bypass,
                trompValues,
                d25,
                d75,
                misplacementIndex
            };
        }

        function setStatusIndicator(metric, value, goodThreshold, fairThreshold, lowerIsBetter = false) {
            const statusElement = document.getElementById(`${metric}-status`);
            let status, statusClass;
            
            if (value === null || typeof value === 'undefined' || isNaN(value)) {
                statusElement.textContent = 'N/A';
                statusElement.className = 'kpi-label';
                return;
            }

            if (lowerIsBetter) {
                if (value <= goodThreshold) {
                    status = 'Good';
                    statusClass = 'good';
                } else if (value <= fairThreshold) {
                    status = 'Fair';
                    statusClass = 'fair';
                } else {
                    status = 'Poor';
                    statusClass = 'poor';
                }
            } else {
                if (value >= goodThreshold) {
                    status = 'Good';
                    statusClass = 'good';
                } else if (value >= fairThreshold) {
                    status = 'Fair';
                    statusClass = 'fair';
                } else {
                    status = 'Poor';
                    statusClass = 'poor';
                }
            }
            
            statusElement.textContent = status;
            statusElement.className = 'kpi-label ' + statusClass;
        }

        function displayTrompResults(results) {
            document.getElementById('separation-eff-value').textContent = results.separationEfficiency.toFixed(1) + '%';
            document.getElementById('cut-size-value').textContent = results.cutSize ? results.cutSize.toFixed(1) + ' μm' : 'N/A';
            document.getElementById('bypass-factor-value').textContent = results.bypass.toFixed(1) + '%';
            document.getElementById('misplacement-index-value').textContent = results.misplacementIndex.toFixed(3) : 'N/A';
            
            // Update calculated fields
            document.getElementById('calc-separator-efficiency').value = results.separationEfficiency.toFixed(1);
            document.getElementById('calc-cut-size').value = results.cutSize ? results.cutSize.toFixed(1) : '';
            document.getElementById('calc-bypass-factor').value = results.bypass.toFixed(1);
            document.getElementById('calc-misplacement-index').value = results.misplacementIndex.toFixed(3);
            
            // Set status indicators
            const sep_eff_good = parseFloat(document.getElementById('target-sep-eff-good').value) || 85;
            const sep_eff_fair = parseFloat(document.getElementById('target-sep-eff-fair').value) || 75;
            setStatusIndicator('separation-eff', results.separationEfficiency, sep_eff_good, sep_eff_fair, false);
            
            const d50_good = parseFloat(document.getElementById('target-d50-good').value) || 30;
            const d50_fair = parseFloat(document.getElementById('target-d50-fair').value) || 35;
            setStatusIndicator('cut-size', results.cutSize, d50_good, d50_fair, true);
            
            const bypass_good = parseFloat(document.getElementById('target-bypass-good').value) || 10;
            const bypass_fair = parseFloat(document.getElementById('target-bypass-fair').value) || 15;
            setStatusIndicator('bypass-factor', results.bypass, bypass_good, bypass_fair, true);
            
            const misplacement_good = parseFloat(document.getElementById('target-misplacement-good').value) || 0.35;
            const misplacement_fair = parseFloat(document.getElementById('target-misplacement-fair').value) || 0.5;
            setStatusIndicator('misplacement-index', results.misplacementIndex, misplacement_good, misplacement_fair, true);

            generateTrompCharts(collectPSDData(), results);
            generateTrompRecommendations(results);
        }

        function updateSeparationData(results) {
            const tbody = document.getElementById('separation-data-body');
            tbody.innerHTML = '';
            
            const psdData = collectPSDData();
            
            for (let i = 0; i < psdData.sieveSizes.length; i++) {
                const feedDist = getFractionalPassing(psdData.feed)[i];
                const separationProb = 100 - results.trompValues[i];
                const rejectionRate = results.trompValues[i];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${psdData.sieveSizes[i]}</td>
                    <td>${feedDist.toFixed(1)}</td>
                    <td>${separationProb.toFixed(1)}</td>
                    <td>${rejectionRate.toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            }
        }

        function generateTrompCharts(psdData, results) {
            // Tromp Curve Chart
            const trompCtx = document.getElementById('tromp-curve-chart').getContext('2d');
            
            if (window.trompChart) {
                window.trompChart.destroy();
            }
            
            window.trompChart = new Chart(trompCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Tromp Curve',
                        data: psdData.sieveSizes.map((size, i) => ({x: size, y: results.trompValues[i]})),
                        backgroundColor: 'rgba(37, 99, 235, 0.7)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 2,
                        pointRadius: 5,
                        showLine: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Particle Size (μm)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability of Rejection (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tromp Curve'
                        }
                    }
                }
            });
            
            // PSD Chart
            const psdCtx = document.getElementById('psd-chart').getContext('2d');
            
            if (window.psdChart) {
                window.psdChart.destroy();
            }
            
            window.psdChart = new Chart(psdCtx, {
                type: 'line',
                data: {
                    labels: psdData.sieveSizes,
                    datasets: [
                        {
                            label: 'Feed',
                            data: psdData.feed,
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Fines',
                            data: psdData.fines,
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Rejects',
                            data: psdData.rejects,
                            borderColor: 'rgba(37, 99, 235, 1)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Particle Size (μm)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cumulative % Passing'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Particle Size Distribution'
                        }
                    }
                }
            });

            // KPI Chart
            const kpiCtx = document.getElementById('kpi-chart').getContext('2d');
            if (window.kpiChart) {
                window.kpiChart.destroy();
            }
            
            const sep_eff_good_val = parseFloat(document.getElementById('target-sep-eff-good').value) || 85;
            const bypass_gypass_good_val = parseFloat(document.getElementById('target-bypass-good').value) || 10;
            const misplacement_good_val = parseFloat(document.getElementById('target-misplacement-good').value) || 0.35;
            const kpiLabels = ['Separation Efficiency', 'Bypass Factor', 'Misplacement Index'];
            const actualValues = [
                results.separationEfficiency !== null ? parseFloat(results.separationEfficiency.toFixed(2)) : null,
                results.bypass !== null ? parseFloat(results.bypass.toFixed(2)) : null,
                results.misplacementIndex !== null ? parseFloat(results.misplacementIndex.toFixed(3)) : null
            ];
            const goodValues = [sep_eff_good_val, bypass_bypass_good_val, misplacement_good_val];
            
            window.kpiChart = new Chart(kpiCtx, {
                type: 'bar',
                data: {
                    labels: kpiLabels,
                    datasets: [
                        {
                            label: 'Actual',
                            data: actualValues,
                            backgroundColor: 'rgba(37, 99, 235, 0.7)'
                        },
                        {
                            label: 'Target (Good)',
                            data: goodValues,
                            backgroundColor: 'rgba(16, 185, 129, 0.5)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tromp Curve KPIs vs Good Targets'
                        }
                    }
                }
            });
        }

        function generateTrompRecommendations(results) {
            let recommendations = '';
            
            const sep_eff_good = parseFloat(document.getElementById('target-sep-eff-good').value) || 85;
            const bypass_good = parseFloat(document.getElementById('target-bypass-good').value) || 10;
            const misplacement_good = parseFloat(document.getElementById('target-misplacement-good').value) || 0.35;

            if (results.separationEfficiency < sep_eff_good) {
                recommendations += `<p data-en="• Separation efficiency is below target (${sep_eff_good}%). Check separator operating parameters." data-ar="• كفاءة الفصل أقل من الهدف (${sep_eff_good}%). تحقق من معاملات تشغيل المصنف.">• Separation efficiency is below target (${sep_eff_good}%). Check separator operating parameters.</p>`;
            }
            
            if (results.bypass > bypass_good) {
                recommendations += `<p data-en="• Bypass factor is above target (${bypass_good}%). Check for mechanical issues or material dispersion problems." data-ar="• عامل التجاوز أعلى من الهدف (${bypass_good}%). تحقق من المشاكل الميكانيكية أو مشاكل تشتت المادة.">• Bypass factor is above target (${bypass_good}%). Check for mechanical issues or material dispersion problems.</p>`;
            }
            
            if (results.misplacementIndex > misplacement_good) {
                recommendations += `<p data-en="• Misplacement index is high (above ${misplacement_good}). Consider optimizing separator settings." data-ar="• مؤشر الخسارة مرتفع (أعلى من ${misplacement_good}). فكر في تحسين إعدادات المصنف.">• Misplacement index is high (above ${misplacement_good}). Consider optimizing separator settings.</p>`;
            }
            
            recommendations += '<p data-en="• Regularly monitor Tromp curve parameters for consistent performance." data-ar="• راقب بانتظام معاملات منحنى ترومب للأداء المتسق.">• Regularly monitor Tromp curve parameters for consistent performance.</p>';
            recommendations += '<p data-en="• Ensure proper separator maintenance and optimal air flow settings." data-ar="• تأكد من الصيانة المناسبة للمصنف وإعدادات تدفق الهواء المثلى.">• Ensure proper separator maintenance and optimal air flow settings.</p>';
            
            document.getElementById('recommendations-content').innerHTML = recommendations;
        }
        
        // Button event listeners
        document.getElementById('add-sieve-row').addEventListener('click', function() {
            addSieveRow();
        });
        
        document.getElementById('add-default-sieves').addEventListener('click', function() {
            const commonSizes = [0.5, 1, 2, 5, 10, 20, 30, 40, 50, 63, 80, 100, 150, 300];
            commonSizes.forEach(size => {
                if (!sieveSizeExists(size)) {
                    addSieveRow(size);
                }
            });
            updateMassBalanceSieveSelect();
        });
        
        document.getElementById('print-report').addEventListener('click', function() {
            window.print();
        });
        
        document.getElementById('new-analysis').addEventListener('click', function() {
            document.getElementById('results-section').style.display = 'none';
        });

        // API Testing functions
        document.getElementById('test-api').addEventListener('click', function() {
            alert('API test functionality would be implemented here');
        });
        
        document.getElementById('ai-analysis-btn').addEventListener('click', function() {
            alert('AI analysis functionality would be implemented here');
        });
        
        document.getElementById('save-api-key').addEventListener('click', function() {
            const apiKey = document.getElementById('api-key').value;
            if (apiKey) {
                localStorage.setItem('tromp_curve_api_key', apiKey);
                updateApiStatus('connected', 'API: Connected (Key saved)');
                alert('API Key saved successfully!');
            } else {
                alert('Please enter an API key first!');
            }
        });

        // Save/Load Data functions
        document.getElementById('save-data').addEventListener('click', function() {
            const psdData = collectPSDData();
            const info = {
                companyName: document.getElementById('company-name').value || '',
                reportDate: document.getElementById('report-date').value || '',
                preparedBy: document.getElementById('report-preparer').value || '',
                position: document.getElementById('report-position').value || '',
                productType: document.getElementById('product-type').value || '',
                productionDate: document.getElementById('production-date').value || '',
                separatorType: document.getElementById('separator-type').value || '',
                separatorModel: document.getElementById('separator-model').value || '',
                airFlow: document.getElementById('air-flow').value || '',
                particleSizeRange: document.getElementById('particle-size-range').value || '',
                feedRate: document.getElementById('feed-rate').value || '',
                finesRate: document.getElementById('fines-rate').value || '',
                rejectsRate: document.getElementById('rejects-rate').value || '',
                separatorEfficiency: document.getElementById('separator-efficiency').value || '',
                cutSize: document.getElementById('cut-size').value || '',
                notes: document.getElementById('additional-notes').value || ''
            };
            
            if (psdData.sieveSizes.length === 0) {
                alert('No particle size data to save.');
                return;
            }
            
            const saveObj = { psdData: psdData, generalInfo: info };
            try {
                localStorage.setItem('trompCurveSavedData', JSON.stringify(saveObj));
                alert('Data saved successfully!');
            } catch (e) {
                alert('Unable to save data: ' + e.message);
            }
        });
        
        document.getElementById('load-data').addEventListener('click', function() {
            const saved = localStorage.getItem('trompCurveSavedData');
            if (!saved) {
                alert('No saved data found.');
                return;
            }
            try {
                const data = JSON.parse(saved);
                // Populate general info
                if (data.generalInfo) {
                    document.getElementById('company-name').value = data.generalInfo.companyName || '';
                    document.getElementById('report-date').value = data.generalInfo.reportDate || '';
                    document.getElementById('report-preparer').value = data.generalInfo.preparedBy || '';
                    document.getElementById('report-position').value = data.generalInfo.position || '';
                    document.getElementById('product-type').value = data.generalInfo.productType || '';
                    document.getElementById('production-date').value = data.generalInfo.productionDate || '';
                    document.getElementById('separator-type').value = data.generalInfo.separatorType || '';
                    document.getElementById('separator-model').value = data.generalInfo.separatorModel || '';
                    document.getElementById('air-flow').value = data.generalInfo.airFlow || '';
                    document.getElementById('particle-size-range').value = data.generalInfo.particleSizeRange || '';
                    document.getElementById('feed-rate').value = data.generalInfo.feedRate || '';
                    document.getElementById('fines-rate').value = data.generalInfo.finesRate || '';
                    document.getElementById('rejects-rate').value = data.generalInfo.rejectsRate || '';
                    document.getElementById('separator-efficiency').value = data.generalInfo.separatorEfficiency || '';
                    document.getElementById('cut-size').value = data.generalInfo.cutSize || '';
                    document.getElementById('additional-notes').value = data.generalInfo.notes || '';
                }
                // Populate PSD table
                const tbody = document.getElementById('psd-table-body');
                tbody.innerHTML = '';
                if (data.psdData && data.psdData.sieveSizes) {
                    data.psdData.sieveSizes.forEach(() => {
                        addSieveRow();
                    });
                    const rows = document.querySelectorAll('#psd-table-body tr');
                    rows.forEach((row, idx) => {
                        const inputs = row.querySelectorAll('input');
                        if (inputs.length >= 4) {
                            inputs[0].value = data.psdData.sieveSizes[idx] !== undefined ? data.psdData.sieveSizes[idx] : '';
                            inputs[1].value = data.psdData.feed[idx] !== undefined ? data.psdData.feed[idx] : '';
                            inputs[2].value = data.psdData.fines[idx] !== undefined ? data.psdData.fines[idx] : '';
                            inputs[3].value = data.psdData.rejects[idx] !== undefined ? data.psdData.rejects[idx] : '';
                        }
                    });
                    updateMassBalanceSieveSelect();
                }
                alert('Saved data loaded successfully.');
            } catch (e) {
                alert('Error loading saved data: ' + e.message);
            }
        });
        
        document.getElementById('load-example').addEventListener('click', function() {
            // Clear existing data
            document.getElementById('psd-table-body').innerHTML = '';
            
            // Example data
            const exampleData = [
                { size: 1, feed: 3.6, fines: 4.9, rejects: 1.9 },
                { size: 2, feed: 6.1, fines: 8.3, rejects: 3.5 },
                { size: 4, feed: 11.0, fines: 14.7, rejects: 6.3 },
                { size: 8, feed: 18.5, fines: 25.4, rejects: 10.1 },
                { size: 16, feed: 31.2, fines: 44.9, rejects: 14.4 },
                { size: 24, feed: 39.7, fines: 58.8, rejects: 16.1 },
                { size: 32, feed: 47.8, fines: 71.1, rejects: 19.1 },
                { size: 48, feed: 60.6, fines: 87.0, rejects: 28.1 },
                { size: 64, feed: 67.7, fines: 92.6, rejects: 37.1 },
                { size: 96, feed: 81.8, fines: 100.0, rejects: 59.5 },
                { size: 200, feed: 95.1, fines: 100.0, rejects: 89.0 }
            ];
            
            exampleData.forEach(data => {
                addSieveRow(data.size);
                const rows = document.querySelectorAll('#psd-table-body tr');
                const lastRow = rows[rows.length - 1];
                const inputs = lastRow.querySelectorAll('input[type="number"]');
                if (inputs.length >= 4) {
                    inputs[1].value = data.feed;
                    inputs[2].value = data.fines;
                    inputs[3].value = data.rejects;
                }
            });
            
            updateMassBalanceSieveSelect();
            document.getElementById('mass-balance-sieve').value = '48';
            
            // Fill form fields
            document.getElementById('company-name').value = 'Asrar Cement Company';
            document.getElementById('report-preparer').value = 'Engineer Ali Ahmed';
            document.getElementById('report-position').value = 'Process Engineer';
            document.getElementById('product-type').value = 'OPC';
            document.getElementById('separator-type').value = '3rd-gen';
            document.getElementById('separator-model').value = 'O-Sepa N-2500';
            document.getElementById('air-flow').value = '240000';
            document.getElementById('particle-size-range').value = '1-200';
            document.getElementById('feed-rate').value = '120';
            document.getElementById('fines-rate').value = '85';
            document.getElementById('rejects-rate').value = '35';
            document.getElementById('separator-efficiency').value = '87.5';
            document.getElementById('cut-size').value = '32.5';
            document.getElementById('additional-notes').value = '• Tromp curve shows good separation sharpness\n• Monitor bypass factor weekly\n• Adjust rotor speed based on product requirements\n• Record all operational parameters';
            
            alert('Example data loaded successfully! Click "Calculate Tromp Curve" to see results.');
        });
    </script>
    <script src="./common.js"></script>
</body>
</html>