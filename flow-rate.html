<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-en="Flow Rate Calculator" data-ar="حاسبة معدلات التدفق">Flow Rate Calculator</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Additional custom styles for separator calculator */
        .kpi-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .kpi-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary-color);
        }
        
        .kpi-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .good { color: var(--success-color); }
        .fair { color: var(--warning-color); }
        .poor { color: var(--danger-color); }
        
        .chart-container {
            height: 400px;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .recommendations {
            background: #fff9e6;
            border-left: 5px solid var(--warning-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .ai-analysis {
            background: #f0f8ff;
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .results-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        /* Splash Screen Styles */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-out;
        }
        
        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .splash-screen h1 {
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 600;
            text-align: center;
        }
        
        .splash-screen p {
            font-size: 18px;
            font-style: italic;
            text-align: center;
        }
        
        .splash-screen .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 30px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Print Header and Footer */
        .print-header {
            display: none;
        }
        
        .print-footer {
            display: none;
        }
        
        @media print {
            @page {
                size: A4;
                margin: 0.75in;
            }
            
            .print-header, .print-footer {
                display: block;
                position: fixed;
                left: 0;
                right: 0;
                background: white;
                z-index: 100;
                padding: 10px 0.75in;
            }
            
            .print-header {
                top: 0;
                height: 70px;
                border-bottom: 2px solid var(--primary-color);
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 10pt;
            }
            
            .print-footer {
                bottom: 0;
                height: 30px;
                border-top: 1px solid var(--border-color);
                text-align: center;
                font-size: 9pt;
                color: var(--text-secondary);
                line-height: 30px;
            }
            
            body {
                padding-top: 80px;
                padding-bottom: 40px;
                font-size: 12pt;
            }
            
            .no-print {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid var(--border-color);
                page-break-inside: avoid;
            }
            
            .chart-container {
                page-break-inside: avoid;
            }
        }
        
        /* Custom styles for this calculator */
        .developer-info {
            background: var(--gradient-primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .developer-info h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .developer-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .api-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .api-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen">
        <div>
            <h1 data-en="Flow Rate Calculator" data-ar="حاسبة معدلات التدفق">Flow Rate Calculator</h1>
            <p data-en="Developed by: Mr. Fadi M. Darwesh" data-ar="تطوير: السيد فادي م. درويش">Developed by: Mr. Fadi M. Darwesh</p>
            <p data-en="QC & R&D Specialist" data-ar="أخصائي ضمان الجودة والبحوث والتطوير">QC & R&D Specialist</p>
            <p data-en="asrar.cement@gmail.com" data-ar="asrar.cement@gmail.com">asrar.cement@gmail.com</p>
            <div class="loader"></div>
        </div>
    </div>

    <!-- Print Header -->
    <div class="print-header">
        <div>
            <strong data-en="Flow Rate Calculator" data-ar="حاسبة معدلات التدفق">Flow Rate Calculator</strong>
        </div>
        <div>
            <strong data-en="Confidential Report" data-ar="تقرير سري">Confidential Report</strong>
        </div>
    </div>

    <!-- Print Footer -->
    <div class="print-footer">
        <span data-en="Mr. Fadi M. Darwesh - QC & R&D Specialist - asrar.cement@gmail.com" data-ar="السيد فادي م. درويش - أخصائي ضمان الجودة والبحوث والتطوير - asrar.cement@gmail.com">Mr. Fadi M. Darwesh - QC & R&D Specialist - asrar.cement@gmail.com</span>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header no-print">
            <div class="header-content">
                <div class="logo">
                    <h1 data-en="Flow Rate Calculator" data-ar="حاسبة معدلات التدفق">Flow Rate Calculator</h1>
                </div>
                <div class="header-controls">
                    <div class="language-switch">
                        <button class="lang-btn active" id="lang-en">English</button>
                        <button class="lang-btn" id="lang-ar">العربية</button>
                    </div>
                </div>
            </div>
        <a href="index.html" class="back-btn" style="position: fixed; top: 20px; right: 20px; background: var(--secondary); color: white; padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; z-index: 100;"><i class="fas fa-arrow-right"></i>العودة للرئيسية</a>
</header>

        <div class="main-content">
            <!-- Hero Section -->
            <section class="hero-section">
                <div class="hero-content">
                    <h2 data-en="Advanced Separator Efficiency Calculator" data-ar="حاسبة كفاءة المصنف المتقدمة">Advanced Separator Efficiency Calculator</h2>
                    <p data-en="Comprehensive analysis tool for cement separator performance evaluation using Tromp curve analysis and industry-standard KPIs" data-ar="أداة شاملة لتحليل أداء مصنفات الأسمنت باستخدام تحليل منحنى ترومب والمؤشرات القياسية للصناعة">Comprehensive analysis tool for cement separator performance evaluation using Tromp curve analysis and industry-standard KPIs</p>
                </div>
            </section>

            <!-- Company & Report Information -->
            <div class="card">
                <h2 class="section-title" data-en="Company & Report Information" data-ar="معلومات الشركة والتقرير">Company & Report Information</h2>
                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="company-name" data-en="Company Name" data-ar="اسم الشركة">Company Name</label>
                        <input type="text" id="company-name" placeholder="Enter company name">
                    </div>
                    <div class="input-group">
                        <label for="report-date" data-en="Report Date" data-ar="تاريخ التقرير">Report Date</label>
                        <input type="date" id="report-date">
                    </div>
                    <div class="input-group">
                        <label for="report-preparer" data-en="Report Prepared By" data-ar="معد التقرير">Report Prepared By</label>
                        <input type="text" id="report-preparer" placeholder="Enter preparer name">
                    </div>
                    <div class="input-group">
                        <label for="report-position" data-en="Preparer Position" data-ar="منصب معد التقرير">Preparer Position</label>
                        <input type="text" id="report-position" placeholder="Enter preparer position">
                    </div>
                    <div class="input-group">
                        <label for="product-type" data-en="Product Type" data-ar="نوع المنتج">Product Type</label>
                        <input type="text" id="product-type" placeholder="e.g., OPC, PPC, etc.">
                    </div>
                    <div class="input-group">
                        <label for="production-date" data-en="Production Date" data-ar="تاريخ الإنتاج">Production Date</label>
                        <input type="date" id="production-date">
                    </div>
                </div>
            </div>

            <!-- Separator Performance Targets -->
            <div class="card">
                <h2 class="section-title" data-en="Separator-Specific Information" data-ar="معلومات المصنف المحددة">Separator-Specific Information</h2>
                <div class="grid-3" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="separator-type" data-en="Separator Type" data-ar="نوع المصنف">Separator Type</label>
                        <select id="separator-type">
                            <option value="" data-en="Select Separator Type" data-ar="اختر نوع المصنف">Select Separator Type</option>
                            <option value="1st-gen" data-en="1st Generation (Sturtevant, Raymond)" data-ar="الجيل الأول (ستورتفانت، ريموند)">1st Generation (Sturtevant, Raymond)</option>
                            <option value="2nd-gen" data-en="2nd Generation (Cyclone Air Separator)" data-ar="الجيل الثاني (سايكلون)">2nd Generation (Cyclone Air Separator)</option>
                            <option value="3rd-gen" data-en="3rd Generation (HES - O-Sepa, Sepax, Sepmaster)" data-ar="الجيل الثالث (عالية الكفاءة)">3rd Generation (HES - O-Sepa, Sepax, Sepmaster)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="separator-model" data-en="Separator Model" data-ar="موديل المصنف">Separator Model</label>
                        <input type="text" id="separator-model" placeholder="e.g., O-Sepa, Sepax, etc.">
                    </div>
                    <div class="input-group">
                        <label for="air-flow" data-en="Separator Air Flow (m³/h)" data-ar="تدفق الهواء في المصنف (م³/ساعة)">Separator Air Flow (m³/h)</label>
                        <input type="number" id="air-flow" placeholder="Enter air flow">
                    </div>
                </div>
            </div>

            <!-- Performance Target Settings -->
            <div class="card">
                <h2 class="section-title" data-en="Performance Target Settings" data-ar="إعدادات الأهداف المعتمدة">Performance Target Settings</h2>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 15px;" data-en="Set your factory's specific targets for 'Good' and 'Fair' ratings." data-ar="حدد أهداف مصنعك الخاصة لتقييمات 'جيد' و 'مقبول'.">Set your factory's specific targets for 'Good' and 'Fair' ratings.</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-en="KPI" data-ar="المؤشر">KPI</th>
                            <th data-en="Rating Logic" data-ar="منطق التقييم">Rating Logic</th>
                            <th data-en="Target: Good" data-ar="الهدف: جيد">Target: Good</th>
                            <th data-en="Target: Fair" data-ar="الهدف: مقبول">Target: Fair</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td data-en="Circulating Load (%)" data-ar="الحمل المتداول (%)">Circulating Load (%)</td>
                            <td><span data-en="Higher is Better" data-ar="الأعلى أفضل">Higher is Better</span></td>
                            <td><input type="number" id="target-cl-good" value="150" step="10"></td>
                            <td><input type="number" id="target-cl-fair" value="120" step="10"></td>
                        </tr>
                        <tr>
                            <td data-en="Separator Efficiency (%)" data-ar="كفاءة المصنف (%)">Separator Efficiency (%)</td>
                            <td><span data-en="Higher is Better" data-ar="الأعلى أفضل">Higher is Better</span></td>
                            <td><input type="number" id="target-eff-good" value="85" step="1"></td>
                            <td><input type="number" id="target-eff-fair" value="75" step="1"></td>
                        </tr>
                        <tr>
                            <td data-en="Cut Size d50 (μm)" data-ar="حجم القطع d50 (μm)">Cut Size d50 (μm)</td>
                            <td><span data-en="Lower is Better" data-ar="الأقل أفضل">Lower is Better</span></td>
                            <td><input type="number" id="target-d50-good" value="30" step="1"></td>
                            <td><input type="number" id="target-d50-fair" value="35" step="1"></td>
                        </tr>
                        <tr>
                            <td data-en="Imperfection" data-ar="عدم الكمال">Imperfection</td>
                            <td><span data-en="Lower is Better" data-ar="الأقل أفضل">Lower is Better</span></td>
                            <td><input type="number" id="target-imp-good" value="0.35" step="0.01"></td>
                            <td><input type="number" id="target-imp-fair" value="0.5" step="0.01"></td>
                        </tr>
                        <tr>
                            <td data-en="Bypass (%)" data-ar="التجاوز (%)">Bypass (%)</td>
                            <td><span data-en="Lower is Better" data-ar="الأقل أفضل">Lower is Better</span></td>
                            <td><input type="number" id="target-bypass-good" value="10" step="1"></td>
                            <td><input type="number" id="target-bypass-fair" value="15" step="1"></td>
                        </tr>
                        <tr>
                            <td data-en="Sharpness" data-ar="الحدة">Sharpness</td>
                            <td><span data-en="Higher is Better" data-ar="الأعلى أفضل">Higher is Better</span></td>
                            <td><input type="number" id="target-sharp-good" value="0.6" step="0.01"></td>
                            <td><input type="number" id="target-sharp-fair" value="0.4" step="0.01"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Data Input Tables -->
            <div class="card">
                <h2 class="section-title" data-en="Particle Size Distribution Data" data-ar="بيانات توزيع حجم الجسيمات">Particle Size Distribution Data</h2>
                
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="mass-balance-sieve" data-en="Sieve for Mass Balance Calculation" data-ar="منخل حساب موازنة الكتلة">Sieve for Mass Balance Calculation</label>
                    <select id="mass-balance-sieve" style="max-width: 300px;"></select>
                    <small style="color: var(--text-secondary); display: block; margin-top: 5px;" data-en="Select the reference sieve for calculating Circulating Load. This sieve must have Feed, Fines, and Rejects data." data-ar="اختر المنخل المرجعي لحساب الحمل المتداول. يجب أن يحتوي هذا المنخل على بيانات للتغذية، الناعم، والمرفوض.">Select the reference sieve for calculating Circulating Load. This sieve must have Feed, Fines, and Rejects data.</small>
                </div>
                
                <p style="text-align: center; margin: 15px 0; color: var(--text-secondary);" data-en="Enter cumulative percentage passing for each sieve size:" data-ar="أدخل النسبة المئوية التراكمية المارة لكل منخل:">Enter cumulative percentage passing for each sieve size:</p>
                
                <table class="data-table" id="psd-table">
                    <thead>
                        <tr>
                            <th data-en="Sieve Size (μm)" data-ar="حجم المنخل (ميكرومتر)">Sieve Size (μm)</th>
                            <th data-en="Feed (% Passing)" data-ar="التغذية (% مار)">Feed (% Passing)</th>
                            <th data-en="Fines (% Passing)" data-ar="الناعم (% مار)">Fines (% Passing)</th>
                            <th data-en="Rejects (% Passing)" data-ar="المرفوض (% مار)">Rejects (% Passing)</th>
                            <th data-en="Actions" data-ar="الإجراءات">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="psd-table-body">
                    </tbody>
                </table>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="add-sieve-row" data-en="Add Sieve Size" data-ar="إضافة حجم منخل">Add Sieve Size</button>
                    <button class="btn btn-secondary" id="add-default-sieves" data-en="Add Common Sieves" data-ar="إضافة المناخل الشائعة">Add Common Sieves</button>
                    <button class="btn btn-warning" id="load-example" data-en="Load Example Data" data-ar="تحميل بيانات مثال">Load Example Data</button>
                    <button class="btn btn-success" id="save-data" data-en="Save Data" data-ar="حفظ البيانات">Save Data</button>
                    <button class="btn btn-secondary" id="load-data" data-en="Load Data" data-ar="تحميل البيانات">Load Data</button>
                    <button class="btn btn-lg btn-primary" id="calculate-btn" data-en="Calculate Efficiency" data-ar="حساب الكفاءة">Calculate Efficiency</button>
                </div>
            </div>

            <!-- Advanced AI Analysis -->
            <div class="card">
                <h2 class="section-title" data-en="Advanced AI Analysis" data-ar="التحليل المتقدم بالذكاء الاصطناعي">Advanced AI Analysis</h2>
                
                <div id="api-status" class="api-status disconnected" data-en="API: Disconnected" data-ar="API: غير متصل">
                    API: Disconnected
                </div>
                
                <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label for="api-key" data-en="OpenAI API Key" data-ar="مفتاح OpenAI API">OpenAI API Key</label>
                        <input type="password" id="api-key" placeholder="Enter your OpenAI API key">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;" data-en="Get your API key from https://platform.openai.com" data-ar="احصل على المفتاح من https://platform.openai.com">Get your API key from https://platform.openai.com</small>
                    </div>
                    <div class="input-group">
                        <label for="api-model" data-en="AI Model" data-ar="نموذج الذكاء الاصطناعي">AI Model</label>
                        <select id="api-model">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast & Cost-effective)</option>
                            <option value="gpt-4">GPT-4 (Most Advanced)</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="test-api" data-en="Test API Connection" data-ar="اختبار اتصال API">Test API Connection</button>
                    <button class="btn btn-primary" id="ai-analysis-btn" data-en="Get AI Analysis" data-ar="الحصول على تحليل الذكاء الاصطناعي">Get AI Analysis</button>
                    <button class="btn btn-success" id="save-api-key" data-en="Save API Key" data-ar="حفظ المفتاح">Save API Key</button>
                </div>
            </div>

            <!-- Additional Notes -->
            <div class="card">
                <h2 class="section-title" data-en="Additional Notes" data-ar="ملاحظات إضافية">Additional Notes</h2>
                <div class="input-group">
                    <label for="additional-notes" data-en="Add your notes and observations here:" data-ar="أضف ملاحظاتك وتوصياتك هنا:">Add your notes and observations here:</label>
                    <textarea id="additional-notes" rows="4" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; font-family: var(--font-arabic);" placeholder="Enter any additional notes, observations, or recommendations..."></textarea>
                </div>
                <small style="color: var(--text-secondary);" data-en="These notes will be included in the final report" data-ar="هذه الملاحظات ستظهر في التقرير النهائي">These notes will be included in the final report</small>
            </div>
            
            <!-- Results Section -->
            <div class="results-section" id="results-section">
                <div class="card">
                    <h2 class="section-title" data-en="Separator Efficiency Results" data-ar="نتائج كفاءة المصنف">Separator Efficiency Results</h2>
                    
                    <div class="grid-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <!-- KPI Cards -->
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Circulating Load" data-ar="الحمل المتداول">Circulating Load</div>
                            <div class="kpi-value" id="cl-value">-</div>
                            <div class="kpi-label" id="cl-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="The circulating load is the ratio of material recirculating between the separator and the mill, expressed as a percentage of the final product. High values indicate heavy recirculation and lower overall efficiency." data-ar="الحمل المتداول هو نسبة المادة التي تدور بين المصنف والطاحونة، ويعبر عنه كنسبة مئوية من المنتج النهائي. القيم العالية تشير إلى إعادة تدوير ثقيلة وكفاءة أقل."></div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Separator Efficiency" data-ar="كفاءة المصنف">Separator Efficiency</div>
                            <div class="kpi-value" id="efficiency-value">-</div>
                            <div class="kpi-label" id="efficiency-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="Separator efficiency is the percentage of fine material (smaller than the cut size) correctly reported to the fines product. It is calculated as 100% minus the bypass." data-ar="كفاءة المصنف هي النسبة المئوية للمادة الناعمة (أصغر من حجم القطع) التي تذهب بشكل صحيح إلى المنتج الناعم. يتم حسابها على أنها 100% مطروحًا منها نسبة التجاوز."></div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Cut Size (d50)" data-ar="حجم القطع (d50)">Cut Size (d50)</div>
                            <div class="kpi-value" id="cutsize-value">-</div>
                            <div class="kpi-label" id="cutsize-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="The cut size d50 is the particle diameter at which there is a 50% probability of being rejected to the coarse product. It characterizes the separator's cut point." data-ar="حجم القطع d50 هو قطر الجسيم الذي توجد عنده احتمالية 50% للانتقال إلى المنتج الخشن. يحدد هذا الحجم نقطة القطع للمصنف."></div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Imperfection" data-ar="عدم الكمال">Imperfection</div>
                            <div class="kpi-value" id="imperfection-value">-</div>
                            <div class="kpi-label" id="imperfection-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="Imperfection is defined as (d75 – d25) divided by twice d50. It measures the width of the cut: smaller values indicate a sharper separation." data-ar="معامل عدم الكمال يُعرَّف على أنه (d75 – d25) مقسوم على ضعف d50. يقيس عرض القطع؛ القيم الصغيرة تشير إلى فصل أكثر حدة."></div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Bypass" data-ar="التجاوز">Bypass</div>
                            <div class="kpi-value" id="bypass-value">-</div>
                            <div class="kpi-label" id="bypass-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="Bypass (or fines entrainment) is the fraction of coarse feed that erroneously reports to the fines product at zero probability of rejection. It corresponds to the minimum value of the Tromp curve." data-ar="التجاوز أو تمرير الخشن إلى الناعم هو جزء من التغذية الخشنة التي تذهب خطأً إلى المنتج الناعم عند احتمالية رفض صفرية. يمثل أقل قيمة لمنحنى ترومب."></div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-label" data-en="Sharpness" data-ar="الحدة">Sharpness</div>
                            <div class="kpi-value" id="sharpness-value">-</div>
                            <div class="kpi-label" id="sharpness-status">-</div>
                            <div class="kpi-desc" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; line-height: 1.4;" data-en="Sharpness is the ratio d25/d75, indicating the steepness of the Tromp curve. Higher values mean a steeper (sharper) separation." data-ar="الحدة هي نسبة d25 إلى d75 وتمثل انحدار منحنى ترومب؛ كلما زادت القيمة كان الفصل أكثر حدة."></div>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="chart-container">
                        <canvas id="tromp-curve-chart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="psd-chart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="kpi-chart"></canvas>
                    </div>
                    
                    <!-- Detailed Calculations -->
                    <div class="report-section">
                        <h3 class="section-heading" data-en="Detailed Calculations" data-ar="الحسابات التفصيلية">Detailed Calculations</h3>
                        <div id="detailed-calculations"></div>
                    </div>
                    
                    <!-- AI Analysis -->
                    <div class="ai-analysis" id="ai-analysis-container">
                        <h3 class="section-heading" data-en="AI Analysis" data-ar="تحليل الذكاء الاصطناعي">AI Analysis</h3>
                        <div id="ai-analysis-content">
                            <p data-en="No AI analysis available yet. Click 'Get AI Analysis' to generate." data-ar="لا يوجد تحليل بالذكاء الاصطناعي بعد. انقر على 'الحصول على تحليل الذكاء الاصطناعي' لإنشائه.">No AI analysis available yet. Click 'Get AI Analysis' to generate.</p>
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div class="recommendations">
                        <h3 class="section-heading" data-en="Recommendations" data-ar="التوصيات">Recommendations</h3>
                        <div id="recommendations-content"></div>
                    </div>
                    
                    <div class="button-group no-print">
                        <button class="btn btn-success" id="print-report" data-en="Print Report" data-ar="طباعة التقرير">Print Report</button>
                        <button class="btn btn-warning" id="export-pdf" data-en="Export as PDF" data-ar="تصدير كـ PDF">Export as PDF</button>
                        <button class="btn btn-secondary" id="new-analysis" data-en="New Analysis" data-ar="تحليل جديد">New Analysis</button>
                    </div>
                </div>
            </div>

            <!-- Developer Information -->
            <div class="developer-info no-print">
                <h3 data-en="System Developer" data-ar="مطور النظام">System Developer</h3>
                <p><strong data-en="Mr. Fadi M. Darwesh" data-ar="السيد فادي م. درويش">Mr. Fadi M. Darwesh</strong></p>
                <p data-en="QC & R&D Specialist" data-ar="أخصائي ضمان الجودة والبحوث والتطوير">QC & R&D Specialist</p>
                <p>asrar.cement@gmail.com</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer no-print">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4 data-en="Separator Efficiency Analysis" data-ar="حاسبة معدلات التدفق">Separator Efficiency Analysis</h4>
                    <p data-en="Advanced calculation tools for cement separator performance evaluation" data-ar="أدوات حساب متقدمة لتقييم أداء مصنفات الأسمنت">Advanced calculation tools for cement separator performance evaluation</p>
                </div>
                <div class="footer-section">
                    <h4 data-en="Developer" data-ar="المطور">Developer</h4>
                    <ul>
                        <li>Mr. Fadi M. Darwesh</li>
                        <li data-en="QC & R&D Specialist" data-ar="أخصائي ضمان الجودة والبحوث والتطوير">QC & R&D Specialist</li>
                        <li>asrar.cement@gmail.com</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4 data-en="Features" data-ar="المميزات">Features</h4>
                    <ul>
                        <li data-en="Tromp Curve Analysis" data-ar="تحليل منحنى ترومب">Tromp Curve Analysis</li>
                        <li data-en="KPI Calculations" data-ar="حسابات المؤشرات">KPI Calculations</li>
                        <li data-en="AI-Powered Insights" data-ar="رؤى مدعومة بالذكاء الاصطناعي">AI-Powered Insights</li>
                        <li data-en="Professional Reports" data-ar="تقارير احترافية">Professional Reports</li>
                    </ul>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--gray-700);">
                <p data-en="© 2025 Flow Rate Calculator System. All rights reserved." data-ar="© 2025 نظام تحليل كفاءة المصنف. جميع الحقوق محفوظة.">© 2025 Flow Rate Calculator System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner">
            <i class="fas fa-cog"></i>
            <p data-en="Calculating..." data-ar="جاري الحساب...">Calculating...</p>
        </div>
    </div>

    <script>
        // Language switching functionality
        document.getElementById('lang-en').addEventListener('click', function() {
            setLanguage('en');
        });
        
        document.getElementById('lang-ar').addEventListener('click', function() {
            setLanguage('ar');
        });
        
        function setLanguage(lang) {
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lang-${lang}`).classList.add('active');
            
            // Update text content based on data attributes
            document.querySelectorAll('[data-en]').forEach(element => {
                if (lang === 'en') {
                    element.textContent = element.getAttribute('data-en');
                } else {
                    element.textContent = element.getAttribute('data-ar');
                }
            });
            
            // Update placeholders
            document.querySelectorAll('input[placeholder], textarea[placeholder]').forEach(element => {
                const enText = element.getAttribute('data-en-placeholder');
                const arText = element.getAttribute('data-ar-placeholder');
                
                if (enText && arText) {
                    element.placeholder = lang === 'en' ? enText : arText;
                }
            });
            
            // Update direction
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
        }
        
        // Initialize with English
        setLanguage('en');
        
        // Initialize splash screen
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('splash-screen').classList.add('hidden');
            }, 2000);
            
            // Set current dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            document.getElementById('production-date').value = today;
            
            // Initialize with common sieves
            addSieveRow(1);
            addSieveRow(2);
            addSieveRow(4);
            addSieveRow(8);
            addSieveRow(16);
            addSieveRow(24);
            addSieveRow(32);
            addSieveRow(48);
            addSieveRow(64);
            addSieveRow(96);
            addSieveRow(200);
            
            // Load saved API key
            const savedApiKey = localStorage.getItem('separator_analyzer_api_key');
            if (savedApiKey) {
                document.getElementById('api-key').value = savedApiKey;
                updateApiStatus('connected', 'API: Connected (Using saved key)');
            }
            
            updateMassBalanceSieveSelect();
        });

        function addSieveRow(defaultSize = '') {
            const tableBody = document.getElementById('psd-table-body');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>
                    <input type="number" step="0.1" min="0.1" class="sieve-size-input" value="${defaultSize}" placeholder="Enter size">
                </td>
                <td>
                    <input type="number" step="0.01" min="0" max="100" class="psd-input" data-stream="feed" placeholder="0-100">
                </td>
                <td>
                    <input type="number" step="0.01" min="0" max="100" class="psd-input" data-stream="fines" placeholder="0-100">
                </td>
                <td>
                    <input type="number" step="0.01" min="0" max="100" class="psd-input" data-stream="rejects" placeholder="0-100">
                </td>
                <td>
                    <button class="btn btn-danger remove-row" data-en="Remove" data-ar="إزالة">Remove</button>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            
            newRow.querySelector('.sieve-size-input').addEventListener('change', updateMassBalanceSieveSelect);
            
            newRow.querySelector('.remove-row').addEventListener('click', function() {
                if (tableBody.children.length > 1) {
                    tableBody.removeChild(newRow);
                    updateMassBalanceSieveSelect();
                } else {
                    alert('You must have at least one sieve size!');
                }
            });
        }

        function updateMassBalanceSieveSelect() {
            const select = document.getElementById('mass-balance-sieve');
            const currentVal = select.value;
            select.innerHTML = '';
            
            const inputs = document.querySelectorAll('.sieve-size-input');
            let sizeFound = false;

            inputs.forEach(input => {
                const size = parseFloat(input.value);
                if (!isNaN(size) && size > 0) {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = `${size} μm`;
                    select.appendChild(option);
                    if (size.toString() === currentVal) {
                        select.value = currentVal;
                        sizeFound = true;
                    }
                }
            });
            
            if (!sizeFound && select.options.length > 0) {
                const defaultSieves = ['48', '64', '96', '200'];
                let selected = false;
                for (const sieve of defaultSieves) {
                    if (Array.from(select.options).some(opt => opt.value === sieve)) {
                        select.value = sieve;
                        selected = true;
                        break;
                    }
                }
                if (!selected) {
                     select.selectedIndex = Math.floor(select.options.length / 2);
                }
            }
        }

        function sieveSizeExists(size) {
            const inputs = document.querySelectorAll('.sieve-size-input');
            for (let input of inputs) {
                if (parseFloat(input.value) === size) {
                    return true;
                }
            }
            return false;
        }

        function updateApiStatus(status, message) {
            const apiStatus = document.getElementById('api-status');
            apiStatus.className = `api-status ${status}`;
            apiStatus.textContent = message;
        }

        // Calculate efficiency
        document.getElementById('calculate-btn').addEventListener('click', function() {
            calculateEfficiency();
        });

        function calculateEfficiency() {
            const psdData = collectPSDData();
            
            if (psdData.sieveSizes.length === 0) {
                alert('Please enter at least one sieve size with data!');
                return;
            }
            
            // Show loading
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            // Simulate calculation delay
            setTimeout(() => {
                const results = performCalculations(psdData);
                
                if (!results) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    return;
                }
                
                document.getElementById('loading-overlay').classList.add('hidden');
                displayResults(results);
                document.getElementById('results-section').style.display = 'block';
            }, 1000);
        }

        // Collect PSD data
        function collectPSDData() {
            const psdData = {
                sieveSizes: [],
                feed: [],
                fines: [],
                rejects: []
            };
            
            const rows = document.querySelectorAll('#psd-table-body tr');
            rows.forEach(row => {
                const sizeInput = row.querySelector('.sieve-size-input');
                const feedInput = row.querySelector('.psd-input[data-stream="feed"]');
                const finesInput = row.querySelector('.psd-input[data-stream="fines"]');
                const rejectsInput = row.querySelector('.psd-input[data-stream="rejects"]');
                
                if (sizeInput && feedInput && finesInput && rejectsInput) {
                    const size = parseFloat(sizeInput.value);
                    const feedVal = parseFloat(feedInput.value);
                    const finesVal = parseFloat(finesInput.value);
                    const rejectsVal = parseFloat(rejectsInput.value);
                    
                    if (!isNaN(size) && size > 0 && 
                        (!isNaN(feedVal) || !isNaN(finesVal) || !isNaN(rejectsVal))) {
                        psdData.sieveSizes.push(size);
                        psdData.feed.push(isNaN(feedVal) ? 0 : feedVal);
                        psdData.fines.push(isNaN(finesVal) ? 0 : finesVal);
                        psdData.rejects.push(isNaN(rejectsVal) ? 0 : rejectsVal);
                    }
                }
            });
            
            // Sort by sieve size (ascending)
            const combined = psdData.sieveSizes.map((size, index) => ({
                size,
                feed: psdData.feed[index],
                fines: psdData.fines[index],
                rejects: psdData.rejects[index]
            }));
            
            combined.sort((a, b) => a.size - b.size);
            
            psdData.sieveSizes = combined.map(item => item.size);
            psdData.feed = combined.map(item => item.feed);
            psdData.fines = combined.map(item => item.fines);
            psdData.rejects = combined.map(item => item.rejects);
            
            return psdData;
        }
        
        // Convert cumulative passing to fractional passing
        function getFractionalPassing(cumulativeArray) {
            const fractional = [];
            let prevPassing = 0;
            for (let i = 0; i < cumulativeArray.length; i++) {
                const currentPassing = Math.max(prevPassing, cumulativeArray[i]);
                const fraction = currentPassing - prevPassing;
                fractional.push(fraction);
                prevPassing = currentPassing;
            }
            return fractional;
        }

        function interpolateSize(targetValue, value1, value2, size1, size2) {
            if (value2 - value1 === 0) {
                return size1;
            }
            const logSize1 = Math.log(size1);
            const logSize2 = Math.log(size2);
            const interpLog = logSize1 + (targetValue - value1) * (logSize2 - logSize1) / (value2 - value1);
            return Math.exp(interpLog);
        }

        function performCalculations(psdData) {
            const clSieveSize = parseFloat(document.getElementById('mass-balance-sieve').value);
            if (isNaN(clSieveSize)) {
                alert('Please select a valid sieve for Mass Balance calculation!');
                return null;
            }
            
            const sieveIndex = psdData.sieveSizes.indexOf(clSieveSize);
            if (sieveIndex === -1) {
                alert(`Selected sieve ${clSieveSize} μm not found in data table.`);
                return null;
            }
            
            const pass_f = psdData.feed[sieveIndex];
            const pass_s = psdData.fines[sieveIndex];
            const pass_g = psdData.rejects[sieveIndex];
            
            const R_f = 100 - pass_f;
            const R_s = 100 - pass_s;
            const R_g = 100 - pass_g;
            
            if (Math.abs(R_g - R_f) < 0.01) {
                alert(`Calculation Error: Feed and Rejects have identical retained values (${R_f.toFixed(1)}%) at ${clSieveSize} μm. Cannot calculate Circulating Load.`);
                return null;
            }
            
            const circulatingLoad = (R_f - R_s) / (R_g - R_f) * 100;
            
            if (circulatingLoad < 0) {
                 alert(`Warning: Calculated Circulating Load is negative (${circulatingLoad.toFixed(1)}%). This indicates a data entry error or sampling issue. Results will be inaccurate.`);
            }

            // Calculate Tromp Curve
            const trompValues = [];
            const CL_ratio = circulatingLoad / 100;
            const s_frac_mass = 1 / (1 + CL_ratio);

            const feed_frac_pass = getFractionalPassing(psdData.feed);
            const fines_frac_pass = getFractionalPassing(psdData.fines);

            for (let i = 0; i < psdData.sieveSizes.length; i++) {
                let prob_to_fines = 0;
                
                if (feed_frac_pass[i] > 0.001) {
                    prob_to_fines = s_frac_mass * (fines_frac_pass[i] / feed_frac_pass[i]);
                } else if (fines_frac_pass[i] > 0.001) {
                    prob_to_fines = 0;
                }
                
                let trompValue = (1 - prob_to_fines) * 100;
                trompValue = Math.max(0, Math.min(trompValue, 100));
                trompValues.push(trompValue);
            }

            // Calculate KPIs
            let d25 = null, d50 = null, d75 = null;
            
            for (let i = 0; i < trompValues.length - 1; i++) {
                if (trompValues[i] <= 25 && trompValues[i+1] >= 25 && d25 === null) {
                    d25 = interpolateSize(25, trompValues[i], trompValues[i+1], psdData.sieveSizes[i], psdData.sieveSizes[i+1]);
                }
                if (trompValues[i] <= 50 && trompValues[i+1] >= 50 && d50 === null) {
                    d50 = interpolateSize(50, trompValues[i], trompValues[i+1], psdData.sieveSizes[i], psdData.sieveSizes[i+1]);
                }
                if (trompValues[i] <= 75 && trompValues[i+1] >= 75 && d75 === null) {
                    d75 = interpolateSize(75, trompValues[i], trompValues[i+1], psdData.sieveSizes[i], psdData.sieveSizes[i+1]);
                }
            }
            
            const imperfection = (d25 && d50 && d75 && d50 > 0) ? (d75 - d25) / (2 * d50) : null;
            const sharpness = (d25 && d75 && d75 > 0) ? d25 / d75 : null;
            const bypass = Math.min(...trompValues);
            const efficiency = 100 - bypass;
            
            return {
                circulatingLoad,
                clSieve: clSieveSize,
                efficiency,
                cutSize: d50,
                imperfection,
                sharpness,
                bypass,
                trompValues,
                d25,
                d75
            };
        }

        function setStatusIndicator(metric, value, goodThreshold, fairThreshold, lowerIsBetter = false) {
            const statusElement = document.getElementById(`${metric}-status`);
            let status, statusClass;
            
            if (value === null || typeof value === 'undefined' || isNaN(value)) {
                statusElement.textContent = 'N/A';
                statusElement.className = 'kpi-label';
                return;
            }

            if (lowerIsBetter) {
                if (value <= goodThreshold) {
                    status = 'Good';
                    statusClass = 'good';
                } else if (value <= fairThreshold) {
                    status = 'Fair';
                    statusClass = 'fair';
                } else {
                    status = 'Poor';
                    statusClass = 'poor';
                }
            } else {
                if (value >= goodThreshold) {
                    status = 'Good';
                    statusClass = 'good';
                } else if (value >= fairThreshold) {
                    status = 'Fair';
                    statusClass = 'fair';
                } else {
                    status = 'Poor';
                    statusClass = 'poor';
                }
            }
            
            statusElement.textContent = status;
            statusElement.className = 'kpi-label ' + statusClass;
        }

        function displayResults(results) {
            document.getElementById('cl-value').textContent = results.circulatingLoad.toFixed(1) + '%';
            document.getElementById('efficiency-value').textContent = results.efficiency.toFixed(1) + '%';
            document.getElementById('cutsize-value').textContent = results.cutSize ? results.cutSize.toFixed(1) + ' μm' : 'N/A';
            document.getElementById('imperfection-value').textContent = results.imperfection ? results.imperfection.toFixed(3) : 'N/A';
            document.getElementById('bypass-value').textContent = results.bypass.toFixed(1) + '%';
            document.getElementById('sharpness-value').textContent = results.sharpness ? results.sharpness.toFixed(3) : 'N/A';
            
            // Set status indicators
            const cl_good = parseFloat(document.getElementById('target-cl-good').value) || 150;
            const cl_fair = parseFloat(document.getElementById('target-cl-fair').value) || 120;
            setStatusIndicator('cl', results.circulatingLoad, cl_good, cl_fair, false);
            
            const eff_good = parseFloat(document.getElementById('target-eff-good').value) || 85;
            const eff_fair = parseFloat(document.getElementById('target-eff-fair').value) || 75;
            setStatusIndicator('efficiency', results.efficiency, eff_good, eff_fair, false);
            
            const d50_good = parseFloat(document.getElementById('target-d50-good').value) || 30;
            const d50_fair = parseFloat(document.getElementById('target-d50-fair').value) || 35;
            setStatusIndicator('cutsize', results.cutSize, d50_good, d50_fair, true);
            
            const imp_good = parseFloat(document.getElementById('target-imp-good').value) || 0.35;
            const imp_fair = parseFloat(document.getElementById('target-imp-fair').value) || 0.5;
            setStatusIndicator('imperfection', results.imperfection, imp_good, imp_fair, true);
            
            const bypass_good = parseFloat(document.getElementById('target-bypass-good').value) || 10;
            const bypass_fair = parseFloat(document.getElementById('target-bypass-fair').value) || 15;
            setStatusIndicator('bypass', results.bypass, bypass_good, bypass_fair, true);
            
            const sharp_good = parseFloat(document.getElementById('target-sharp-good').value) || 0.6;
            const sharp_fair = parseFloat(document.getElementById('target-sharp-fair').value) || 0.4;
            setStatusIndicator('sharpness', results.sharpness, sharp_good, sharp_fair, false);

            generateCharts(collectPSDData(), results);
            generateRecommendations(results);
        }

        function generateCharts(psdData, results) {
            // Tromp Curve Chart
            const trompCtx = document.getElementById('tromp-curve-chart').getContext('2d');
            
            if (window.trompChart) {
                window.trompChart.destroy();
            }
            
            window.trompChart = new Chart(trompCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Tromp Curve',
                        data: psdData.sieveSizes.map((size, i) => ({x: size, y: results.trompValues[i]})),
                        backgroundColor: 'rgba(37, 99, 235, 0.7)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 2,
                        pointRadius: 5,
                        showLine: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Particle Size (μm)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Probability of Rejection (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tromp Curve'
                        }
                    }
                }
            });
            
            // PSD Chart
            const psdCtx = document.getElementById('psd-chart').getContext('2d');
            
            if (window.psdChart) {
                window.psdChart.destroy();
            }
            
            window.psdChart = new Chart(psdCtx, {
                type: 'line',
                data: {
                    labels: psdData.sieveSizes,
                    datasets: [
                        {
                            label: 'Feed',
                            data: psdData.feed,
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Fines',
                            data: psdData.fines,
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Rejects',
                            data: psdData.rejects,
                            borderColor: 'rgba(37, 99, 235, 1)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Particle Size (μm)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cumulative % Passing'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Particle Size Distribution'
                        }
                    }
                }
            });

            // KPI Chart
            const kpiCtx = document.getElementById('kpi-chart').getContext('2d');
            if (window.kpiChart) {
                window.kpiChart.destroy();
            }
            
            const cl_good_val = parseFloat(document.getElementById('target-cl-good').value) || 150;
            const eff_good_val = parseFloat(document.getElementById('target-eff-good').value) || 85;
            const imp_good_val = parseFloat(document.getElementById('target-imp-good').value) || 0.35;
            const sharp_good_val = parseFloat(document.getElementById('target-sharp-good').value) || 0.6;
            const bypass_good_val = parseFloat(document.getElementById('target-bypass-good').value) || 10;
            const kpiLabels = ['Circulating Load', 'Efficiency', 'Imperfection', 'Sharpness', 'Bypass'];
            const actualValues = [
                results.circulatingLoad !== null ? parseFloat(results.circulatingLoad.toFixed(2)) : null,
                results.efficiency !== null ? parseFloat(results.efficiency.toFixed(2)) : null,
                results.imperfection !== null ? parseFloat(results.imperfection.toFixed(3)) : null,
                results.sharpness !== null ? parseFloat(results.sharpness.toFixed(3)) : null,
                results.bypass !== null ? parseFloat(results.bypass.toFixed(2)) : null
            ];
            const goodValues = [cl_good_val, eff_good_val, imp_good_val, sharp_good_val, bypass_good_val];
            
            window.kpiChart = new Chart(kpiCtx, {
                type: 'bar',
                data: {
                    labels: kpiLabels,
                    datasets: [
                        {
                            label: 'Actual',
                            data: actualValues,
                            backgroundColor: 'rgba(37, 99, 235, 0.7)'
                        },
                        {
                            label: 'Target (Good)',
                            data: goodValues,
                            backgroundColor: 'rgba(16, 185, 129, 0.5)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'KPI Performance vs Good Targets'
                        }
                    }
                }
            });
        }

        function generateRecommendations(results) {
            let recommendations = '';
            
            const cl_good = parseFloat(document.getElementById('target-cl-good').value) || 150;
            const eff_good = parseFloat(document.getElementById('target-eff-good').value) || 85;
            const bypass_good = parseFloat(document.getElementById('target-bypass-good').value) || 10;
            const imp_good = parseFloat(document.getElementById('target-imp-good').value) || 0.35;

            if (results.circulatingLoad < cl_good) {
                recommendations += `<p data-en="• Circulating load is below target (${cl_good}%). Consider increasing mill feed rate." data-ar="• الحمل المتداول أقل من الهدف (${cl_good}%). فكر في زيادة معدل تغذية المطحنة.">• Circulating load is below target (${cl_good}%). Consider increasing mill feed rate.</p>`;
            }
            
            if (results.efficiency < eff_good) {
                recommendations += `<p data-en="• Separator efficiency is below target (${eff_good}%). Check bypass and imperfection." data-ar="• كفاءة المصنف أقل من الهدف (${eff_good}%). تحقق من التجاوز وعدم الكمال.">• Separator efficiency is below target (${eff_good}%). Check bypass and imperfection.</p>`;
            }
            
            if (results.bypass > bypass_good) {
                recommendations += `<p data-en="• Bypass is above target (${bypass_good}%). Check for mechanical issues (e.g., air leaks, worn seals) or improve material dispersion." data-ar="• التجاوز أعلى من الهدف (${bypass_good}%). تحقق من المشاكل الميكانيكية (مثل تسرب الهواء، تآكل العوازل) أو حسن تشتت المادة.">• Bypass is above target (${bypass_good}%). Check for mechanical issues (e.g., air leaks, worn seals) or improve material dispersion.</p>`;
            }
            
            if (results.imperfection > imp_good) {
                recommendations += `<p data-en="• Imperfection is high (above ${imp_good}), indicating poor separation sharpness. Consider adjusting rotor speed or air flow." data-ar="• عدم الكمال مرتفع (أعلى من ${imp_good})، مما يشير إلى ضعف حدة الفصل. فكر في ضبط سرعة الدوار أو تدفق الهواء.">• Imperfection is high (above ${imp_good}), indicating poor separation sharpness. Consider adjusting rotor speed or air flow.</p>`;
            }
            
            recommendations += '<p data-en="• Regularly monitor and record separator performance parameters." data-ar="• راقب وسجل بانتظام معاملات أداء المصنف.">• Regularly monitor and record separator performance parameters.</p>';
            recommendations += '<p data-en="• Ensure proper maintenance of separator mechanical components." data-ar="• تأكد من الصيانة المناسبة للمكونات الميكانيكية للمصنف.">• Ensure proper maintenance of separator mechanical components.</p>';
            
            document.getElementById('recommendations-content').innerHTML = recommendations;
        }
        
        // Button event listeners
        document.getElementById('add-sieve-row').addEventListener('click', function() {
            addSieveRow();
        });
        
        document.getElementById('add-default-sieves').addEventListener('click', function() {
            const commonSizes = [0.5, 1, 2, 5, 10, 20, 30, 40, 50, 63, 80, 100, 150, 300];
            commonSizes.forEach(size => {
                if (!sieveSizeExists(size)) {
                    addSieveRow(size);
                }
            });
            updateMassBalanceSieveSelect();
        });
        
        document.getElementById('print-report').addEventListener('click', function() {
            window.print();
        });
        
        document.getElementById('new-analysis').addEventListener('click', function() {
            document.getElementById('results-section').style.display = 'none';
        });

        // API Testing functions
        document.getElementById('test-api').addEventListener('click', function() {
            alert('API test functionality would be implemented here');
        });
        
        document.getElementById('ai-analysis-btn').addEventListener('click', function() {
            alert('AI analysis functionality would be implemented here');
        });
        
        document.getElementById('save-api-key').addEventListener('click', function() {
            const apiKey = document.getElementById('api-key').value;
            if (apiKey) {
                localStorage.setItem('separator_analyzer_api_key', apiKey);
                updateApiStatus('connected', 'API: Connected (Key saved)');
                alert('API Key saved successfully!');
            } else {
                alert('Please enter an API key first!');
            }
        });

        // Save/Load Data functions
        document.getElementById('save-data').addEventListener('click', function() {
            const psdData = collectPSDData();
            const info = {
                companyName: document.getElementById('company-name').value || '',
                reportDate: document.getElementById('report-date').value || '',
                preparedBy: document.getElementById('report-preparer').value || '',
                position: document.getElementById('report-position').value || '',
                productType: document.getElementById('product-type').value || '',
                productionDate: document.getElementById('production-date').value || '',
                separatorType: document.getElementById('separator-type').value || '',
                separatorModel: document.getElementById('separator-model').value || '',
                airFlow: document.getElementById('air-flow').value || '',
                notes: document.getElementById('additional-notes').value || ''
            };
            
            if (psdData.sieveSizes.length === 0) {
                alert('No particle size data to save.');
                return;
            }
            
            const saveObj = { psdData: psdData, generalInfo: info };
            try {
                localStorage.setItem('separatorSavedData', JSON.stringify(saveObj));
                alert('Data saved successfully!');
            } catch (e) {
                alert('Unable to save data: ' + e.message);
            }
        });
        
        document.getElementById('load-data').addEventListener('click', function() {
            const saved = localStorage.getItem('separatorSavedData');
            if (!saved) {
                alert('No saved data found.');
                return;
            }
            try {
                const data = JSON.parse(saved);
                // Populate general info
                if (data.generalInfo) {
                    document.getElementById('company-name').value = data.generalInfo.companyName || '';
                    document.getElementById('report-date').value = data.generalInfo.reportDate || '';
                    document.getElementById('report-preparer').value = data.generalInfo.preparedBy || '';
                    document.getElementById('report-position').value = data.generalInfo.position || '';
                    document.getElementById('product-type').value = data.generalInfo.productType || '';
                    document.getElementById('production-date').value = data.generalInfo.productionDate || '';
                    document.getElementById('separator-type').value = data.generalInfo.separatorType || '';
                    document.getElementById('separator-model').value = data.generalInfo.separatorModel || '';
                    document.getElementById('air-flow').value = data.generalInfo.airFlow || '';
                    document.getElementById('additional-notes').value = data.generalInfo.notes || '';
                }
                // Populate PSD table
                const tbody = document.getElementById('psd-table-body');
                tbody.innerHTML = '';
                if (data.psdData && data.psdData.sieveSizes) {
                    data.psdData.sieveSizes.forEach(() => {
                        addSieveRow();
                    });
                    const rows = document.querySelectorAll('#psd-table-body tr');
                    rows.forEach((row, idx) => {
                        const inputs = row.querySelectorAll('input');
                        if (inputs.length >= 4) {
                            inputs[0].value = data.psdData.sieveSizes[idx] !== undefined ? data.psdData.sieveSizes[idx] : '';
                            inputs[1].value = data.psdData.feed[idx] !== undefined ? data.psdData.feed[idx] : '';
                            inputs[2].value = data.psdData.fines[idx] !== undefined ? data.psdData.fines[idx] : '';
                            inputs[3].value = data.psdData.rejects[idx] !== undefined ? data.psdData.rejects[idx] : '';
                        }
                    });
                    updateMassBalanceSieveSelect();
                }
                alert('Saved data loaded successfully.');
            } catch (e) {
                alert('Error loading saved data: ' + e.message);
            }
        });
        
        document.getElementById('load-example').addEventListener('click', function() {
            // Clear existing data
            document.getElementById('psd-table-body').innerHTML = '';
            
            // Example data
            const exampleData = [
                { size: 1, feed: 3.6, fines: 4.9, rejects: 1.9 },
                { size: 2, feed: 6.1, fines: 8.3, rejects: 3.5 },
                { size: 4, feed: 11.0, fines: 14.7, rejects: 6.3 },
                { size: 8, feed: 18.5, fines: 25.4, rejects: 10.1 },
                { size: 16, feed: 31.2, fines: 44.9, rejects: 14.4 },
                { size: 24, feed: 39.7, fines: 58.8, rejects: 16.1 },
                { size: 32, feed: 47.8, fines: 71.1, rejects: 19.1 },
                { size: 48, feed: 60.6, fines: 87.0, rejects: 28.1 },
                { size: 64, feed: 67.7, fines: 92.6, rejects: 37.1 },
                { size: 96, feed: 81.8, fines: 100.0, rejects: 59.5 },
                { size: 200, feed: 95.1, fines: 100.0, rejects: 89.0 }
            ];
            
            exampleData.forEach(data => {
                addSieveRow(data.size);
                const rows = document.querySelectorAll('#psd-table-body tr');
                const lastRow = rows[rows.length - 1];
                const inputs = lastRow.querySelectorAll('input[type="number"]');
                if (inputs.length >= 4) {
                    inputs[1].value = data.feed;
                    inputs[2].value = data.fines;
                    inputs[3].value = data.rejects;
                }
            });
            
            updateMassBalanceSieveSelect();
            document.getElementById('mass-balance-sieve').value = '48';
            
            // Fill form fields
            document.getElementById('company-name').value = 'Asrar Cement Company';
            document.getElementById('report-preparer').value = 'Engineer Ali Ahmed';
            document.getElementById('report-position').value = 'Process Engineer';
            document.getElementById('product-type').value = 'OPC';
            document.getElementById('separator-type').value = '3rd-gen';
            document.getElementById('separator-model').value = 'O-Sepa N-2500';
            document.getElementById('air-flow').value = '240000';
            document.getElementById('additional-notes').value = '• Monitor separator performance weekly\n• Check rotor blades condition monthly\n• Optimize air flow based on product type\n• Record all operational parameters';
            
            alert('Example data loaded successfully! Click "Calculate Efficiency" to see results.');
        });
    </script>
    <script src="./common.js"></script>
</body>
</html>